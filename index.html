<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Al Cham Chemical Plant - Territory Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  
  <!-- Firebase SDK - Using correct version (9.22.2) -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCMSPqRbQaBqHA2NsdlUc2nOaPx9XxBH2E",
      authDomain: "backend-b4231.firebaseapp.com",
      projectId: "backend-b4231",
      storageBucket: "backend-b4231.firebasestorage.app",
      messagingSenderId: "938964208227",
      appId: "1:938964208227:web:d14d7c45a83027eeb34656",
      measurementId: "G-LVG8XR2067"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // Make db available globally
    window.db = db;
    window.firestoreCollection = collection;
    window.firestoreAddDoc = addDoc;
    window.firestoreGetDocs = getDocs;
    window.firestoreDoc = doc;
    window.firestoreUpdateDoc = updateDoc;
    window.firestoreDeleteDoc = deleteDoc;
    
    // Signal that Firebase is ready
    window.firebaseReady = true;
    const event = new Event('firebase-ready');
    document.dispatchEvent(event);
  </script>
  
  <style>
    #map {
      height: 600px;
      width: 100%;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .custom-marker {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      color: white;
      font-weight: bold;
      border: 2px solid white;
    }
    .status-active {
      background-color: #10B981;
    }
    .status-inactive {
      background-color: #6B7280;
    }
    .status-hard {
      background-color: #EF4444;
    }
    .status-potential {
      background-color: #F59E0B;
    }
    .competitor-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid white;
    }
    .salesperson-marker {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background-color: #3B82F6;
      border: 2px solid white;
      text-align: center;
      line-height: 25px;
      color: white;
      font-weight: bold;
    }
    .add-customer-tooltip {
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-width: 300px;
    }
    .add-customer-tooltip .title {
      font-weight: bold;
      margin-bottom: 8px;
    }
    .add-customer-tooltip input,
    .add-customer-tooltip select {
      width: 100%;
      margin-bottom: 8px;
      padding: 4px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .add-customer-tooltip button {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .add-customer-tooltip .save-btn {
      background-color: #3B82F6;
      color: white;
      margin-right: 4px;
    }
    .add-customer-tooltip .cancel-btn {
      background-color: #9CA3AF;
      color: white;
    }
    .map-mode-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 5px;
    }
    .map-mode-toggle button {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    .map-mode-toggle button.active {
      background-color: #3B82F6;
      color: white;
    }
    .map-mode-toggle button:not(.active) {
      background-color: #F3F4F6;
      color: #374151;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Login Overlay -->
  <div id="loginOverlay" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-lg w-96">
      <div class="flex justify-center mb-6">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNTYgMjU2IiBjbGFzcz0idy0xNiBoLTE2Ij48cGF0aCBmaWxsPSIjMzg4MmY2IiBkPSJNMTI4IDI0YTEwNCAxMDQgMCAxIDAgMTA0IDEwNEExMDQuMTEgMTA0LjExIDAgMCAwIDEyOCAyNFptMCAxOTJhODggODggMCAxIDEgODgtODggODguMSA4OC4xIDAgMCAxLTg4IDg4WiIvPjxwYXRoIGZpbGw9IiMzODgyZjYiIGQ9Ik0xMjggNzJhNTYgNTYgMCAwIDAgMCAxMTIgNTYgNTYgMCAwIDAgMC0xMTJabTAgOTZhNDAgNDAgMCAxIDEgNDAtNDAgNDAuMDUgNDAuMDUgMCAwIDEtNDAgNDBaIi8+PHBhdGggZmlsbD0iIzM4ODJmNiIgZD0iTTEyOCAxMDRhMjQgMjQgMCAxIDAgMjQgMjQgMjQgMjQgMCAwIDAtMjQtMjRaIi8+PC9zdmc+" alt="Logo" class="w-16 h-16">
      </div>
      <h2 class="text-2xl font-bold text-center mb-6">Al Cham Chemical Plant</h2>
      <div class="mb-4">
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
        <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="mb-6">
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <button id="loginButton" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
        Login
      </button>
      <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"></div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <div class="flex items-center">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNTYgMjU2IiBjbGFzcz0idy0xNiBoLTE2Ij48cGF0aCBmaWxsPSIjMzg4MmY2IiBkPSJNMTI4IDI0YTEwNCAxMDQgMCAxIDAgMTA0IDEwNEExMDQuMTEgMTA0LjExIDAgMCAwIDEyOCAyNFptMCAxOTJhODggODggMCAxIDEgODgtODggODguMSA4OC4xIDAgMCAxLTg4IDg4WiIvPjxwYXRoIGZpbGw9IiMzODgyZjYiIGQ9Ik0xMjggNzJhNTYgNTYgMCAwIDAgMCAxMTIgNTYgNTYgMCAwIDAgMC0xMTJabTAgOTZhNDAgNDAgMCAxIDEgNDAtNDAgNDAuMDUgNDAuMDUgMCAwIDEtNDAgNDBaIi8+PHBhdGggZmlsbD0iIzM4ODJmNiIgZD0iTTEyOCAxMDRhMjQgMjQgMCAxIDAgMjQgMjQgMjQgMjQgMCAwIDAtMjQtMjRaIi8+PC9zdmc+" alt="Logo" class="w-10 h-10 mr-2">
          <h1 class="text-xl font-bold text-gray-900">Al Cham Chemical Plant</h1>
        </div>
        <div class="flex items-center">
          <div class="mr-4 text-right">
            <span class="block text-sm text-gray-700" id="currentUserDisplay">User Name</span>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" id="userRoleBadge">
              Role
            </span>
          </div>
          <button id="logoutButton" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 text-sm">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- Tabs -->
      <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8">
          <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="map-tab">
            Map View
          </button>
          <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="customers-tab">
            Customers
          </button>
          <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="competitors-tab">
            Competitors
          </button>
          <button id="adminOnlyTab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="users-tab">
            Users
          </button>
        </nav>
      </div>

      <!-- Map Tab -->
      <div id="map-tab" class="tab-content active">
        <div class="bg-white shadow rounded-lg p-6 mb-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Territory Map</h2>
          
          <!-- Map Filters -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div>
              <label for="mapStatusFilter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="mapStatusFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Statuses</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="hard">Hard</option>
                <option value="potential">Potential</option>
              </select>
            </div>
            <div>
              <label for="mapCategoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <select id="mapCategoryFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Categories</option>
                <option value="paints">Paints</option>
                <option value="alkyde">Alkyde</option>
                <option value="cosmetics">Cosmetics</option>
              </select>
            </div>
            <div>
              <label for="mapCompetitorFilter" class="block text-sm font-medium text-gray-700 mb-1">Competitor</label>
              <select id="mapCompetitorFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Competitors</option>
                <!-- Competitor options will be added dynamically -->
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Show</label>
              <div class="flex space-x-4">
                <label class="inline-flex items-center">
                  <input type="checkbox" id="showCompetitors" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                  <span class="ml-2 text-sm text-gray-700">Competitors</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" id="showSalespersons" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                  <span class="ml-2 text-sm text-gray-700">Salespersons</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Map Container -->
          <div class="relative">
            <div id="map" class="rounded-lg overflow-hidden"></div>
            
            <!-- Map Mode Toggle -->
            <div class="map-mode-toggle">
              <button id="viewModeBtn" class="active">View Mode</button>
              <button id="addModeBtn">Add Customer</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Customers Tab -->
      <div id="customers-tab" class="tab-content">
        <div class="bg-white shadow rounded-lg p-6 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-medium text-gray-900">Customers</h2>
            <button id="addCustomerButton" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
              Add Customer
            </button>
          </div>
          
          <!-- Customer Filters -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label for="customerStatusFilter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="customerStatusFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Statuses</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="hard">Hard</option>
                <option value="potential">Potential</option>
              </select>
            </div>
            <div>
              <label for="customerCategoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <select id="customerCategoryFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Categories</option>
                <option value="paints">Paints</option>
                <option value="alkyde">Alkyde</option>
                <option value="cosmetics">Cosmetics</option>
              </select>
            </div>
            <div>
              <label for="customerCompetitorFilter" class="block text-sm font-medium text-gray-700 mb-1">Competitor</label>
              <select id="customerCompetitorFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Competitors</option>
                <!-- Competitor options will be added dynamically -->
              </select>
            </div>
          </div>
          
          <!-- Customer Form -->
          <div id="customerForm" class="bg-gray-50 p-4 rounded-md mb-6 hidden">
            <h3 class="text-md font-medium text-gray-900 mb-4" id="customerFormTitle">Add New Customer</h3>
            <input type="hidden" id="customerId">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                <input type="text" id="customerName" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
              </div>
              <div>
                <label for="customerStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="customerStatus" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                  <option value="hard">Hard</option>
                  <option value="potential">Potential</option>
                </select>
              </div>
              <div>
                <label for="customerContact" class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                <input type="text" id="customerContact" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label for="customerLat" class="block text-sm font-medium text-gray-700 mb-1">Latitude</label>
                  <input type="text" id="customerLat" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                  <label for="customerLng" class="block text-sm font-medium text-gray-700 mb-1">Longitude</label>
                  <input type="text" id="customerLng" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Categories</label>
                <div class="flex flex-wrap gap-4">
                  <label class="inline-flex items-center">
                    <input type="checkbox" name="customerCategory" value="paints" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-2 text-sm text-gray-700">Paints</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="checkbox" name="customerCategory" value="alkyde" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-2 text-sm text-gray-700">Alkyde</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="checkbox" name="customerCategory" value="cosmetics" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-2 text-sm text-gray-700">Cosmetics</span>
                  </label>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Competitors</label>
                <div id="competitorCheckboxes" class="flex flex-wrap gap-4">
                  <!-- Competitor checkboxes will be added dynamically -->
                </div>
              </div>
              <div class="md:col-span-2">
                <label for="customerRemarks" class="block text-sm font-medium text-gray-700 mb-1">Remarks</label>
                <textarea id="customerRemarks" rows="2" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
              </div>
              <div>
                <label for="lastVisitDate" class="block text-sm font-medium text-gray-700 mb-1">Last Visit Date</label>
                <input type="date" id="lastVisitDate" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
              </div>
              <div>
                <label for="nextVisitDate" class="block text-sm font-medium text-gray-700 mb-1">Next Visit Date</label>
                <input type="date" id="nextVisitDate" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
              </div>
            </div>
            <div class="flex justify-end space-x-3">
              <button id="cancelCustomerButton" class="bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 text-sm">
                Cancel
              </button>
              <button id="saveCustomerButton" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
                Save Customer
              </button>
            </div>
          </div>
          
          <!-- Customer Table -->
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categories</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Competitors</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Visit</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Visit</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="customerTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Customer rows will be added dynamically -->
              </tbody>
            </table>
          </div>
          
          <!-- Export Button -->
          <div id="exportDiv" class="mt-4 flex justify-end">
            <button id="exportCustomersButton" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 text-sm">
              Export to CSV
            </button>
          </div>
        </div>
      </div>

      <!-- Competitors Tab -->
      <div id="competitors-tab" class="tab-content">
        <div class="bg-white shadow rounded-lg p-6 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-medium text-gray-900">Competitors</h2>
            <button id="addCompetitorButton" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
              Add Competitor
            </button>
          </div>
          
          <!-- Competitor Form -->
          <div id="competitorForm" class="bg-gray-50 p-4 rounded-md mb-6 hidden">
            <h3 class="text-md font-medium text-gray-900 mb-4" id="competitorFormTitle">Add New Competitor</h3>
            <input type="hidden" id="competitorId">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label for="competitorName" class="block text-sm font-medium text-gray-700 mb-1">Competitor Name</label>
                <input type="text" id="competitorName" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
              </div>
              <div>
                <label for="competitorLocation" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                <input type="text" id="competitorLocation" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
              </div>
              <div>
                <label for="competitorProducts" class="block text-sm font-medium text-gray-700 mb-1">Products</label>
                <input type="text" id="competitorProducts" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
              </div>
              <div>
                <label for="competitorColor" class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                <input type="color" id="competitorColor" class="w-full h-10 border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500" value="#FF5733">
              </div>
            </div>
            <div class="flex justify-end space-x-3">
              <button id="cancelCompetitorButton" class="bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 text-sm">
                Cancel
              </button>
              <button id="saveCompetitorButton" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
                Save Competitor
              </button>
            </div>
          </div>
          
          <!-- Competitor Table -->
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Products</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Color</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="competitorTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Competitor rows will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users-tab" class="tab-content">
        <div id="adminOnlySection">
          <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-medium text-gray-900">Users</h2>
              <button id="addUserButton" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
                Add User
              </button>
            </div>
            
            <!-- User Form -->
            <div id="userForm" class="bg-gray-50 p-4 rounded-md mb-6 hidden">
              <h3 class="text-md font-medium text-gray-900 mb-4" id="userFormTitle">Add New User</h3>
              <input type="hidden" id="userId">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label for="userFullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                  <input type="text" id="userFullName" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                  <label for="userUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                  <input type="text" id="userUsername" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                  <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input type="password" id="userPassword" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                  <label for="userRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                  <select id="userRole" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="admin">Administrator</option>
                    <option value="salesperson">Salesperson</option>
                  </select>
                </div>
              </div>
              <div class="flex justify-end space-x-3">
                <button id="cancelUserButton" class="bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 text-sm">
                  Cancel
                </button>
                <button id="saveUserButton" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
                  Save User
                </button>
              </div>
            </div>
            
            <!-- User Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                  <!-- User rows will be added dynamically -->
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Salesperson Tracking -->
          <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Salesperson Tracking</h2>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Active</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customers</th>
                  </tr>
                </thead>
                <tbody id="salespersonTableBody" class="bg-white divide-y divide-gray-200">
                  <!-- Salesperson rows will be added dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Global variables
    let map;
    let markers = [];
    let competitorMarkers = [];
    let salespersonMarkers = [];
    let isAuthenticated = false;
    let currentUser = null;
    let trackingInterval = null;
    let mapMode = 'view'; // 'view' or 'add'
    let addCustomerTooltip = null;
    
    // Global data object
    const data = {
      customers: [],
      competitors: [],
      users: []
    };

    // Load data from Firebase
    async function loadFromFirebase() {
      try {
        console.log("Attempting to load data from Firebase...");
        
        // Check if users collection exists, if not create sample data
        const usersSnapshot = await window.firestoreGetDocs(window.firestoreCollection(window.db, 'users'));
        
        if (usersSnapshot.empty) {
          // Create sample data
          console.log("Creating sample data...");
          
          // Add admin user
          const adminRef = await window.firestoreAddDoc(window.firestoreCollection(window.db, 'users'), {
            username: 'Hazem Abdeen',
            password: 'acrylique',
            fullName: 'Hazem Abdeen',
            role: 'admin'
          });
          
          // Add salesperson
          const salesRef = await window.firestoreAddDoc(window.firestoreCollection(window.db, 'users'), {
            username: 'sales1',
            password: 'sales123',
            fullName: 'Ahmad Khalid',
            role: 'salesperson'
          });
          
          // Add competitors
          const comp1 = await window.firestoreAddDoc(window.firestoreCollection(window.db, 'competitors'), {
            name: 'SyriaChem',
            location: 'Damascus Industrial Zone',
            products: 'Industrial chemicals, Solvents',
            color: '#FF5733'
          });
          
          const comp2 = await window.firestoreAddDoc(window.firestoreCollection(window.db, 'competitors'), {
            name: 'MedEast Chemicals',
            location: 'Latakia Port Area',
            products: 'Pharmaceutical chemicals, Reagents',
            color: '#33FF57'
          });
          
          // Add customers
          await window.firestoreAddDoc(window.firestoreCollection(window.db, 'customers'), {
            name: 'Damascus Pharmaceuticals',
            status: 'active',
            contact: '+963 11 123 4567',
            lat: 33.5138,
            lng: 36.2765,
            competitorIds: [comp1.id],
            categories: ['paints', 'cosmetics'],
            remarks: 'Interested in our new product line',
            lastVisit: '2023-05-10',
            nextVisit: '2023-06-15',
            addedBy: adminRef.id,
            addedOn: new Date().toISOString()
          });
          
          await window.firestoreAddDoc(window.firestoreCollection(window.db, 'customers'), {
            name: 'Aleppo Medical Supplies',
            status: 'hard',
            contact: '+963 21 987 6543',
            lat: 36.2021,
            lng: 37.1343,
            competitorIds: [comp2.id],
            categories: ['alkyde'],
            remarks: 'Need to discuss pricing',
            lastVisit: '2023-05-05',
            nextVisit: '2023-06-20',
            addedBy: salesRef.id,
            addedOn: new Date().toISOString()
          });
        }
        
        // Load users
        const usersData = await window.firestoreGetDocs(window.firestoreCollection(window.db, 'users'));
        data.users = usersData.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Load competitors
        const competitorsData = await window.firestoreGetDocs(window.firestoreCollection(window.db, 'competitors'));
        data.competitors = competitorsData.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Load customers
        const customersData = await window.firestoreGetDocs(window.firestoreCollection(window.db, 'customers'));
        data.customers = customersData.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        console.log("Data loaded from Firebase:", data);
      } catch (error) {
        console.error("Error loading data:", error);
        alert("Error connecting to database. Using local data instead.");
        
        // Use sample data as fallback
        data.users = [
          {
            id: "1",
            username: 'Hazem Abdeen',
            password: 'acrylique',
            fullName: 'Hazem Abdeen',
            role: 'admin'
          },
          {
            id: "2",
            username: 'sales1',
            password: 'sales123',
            fullName: 'Ahmad Khalid',
            role: 'salesperson'
          }
        ];
        
        data.competitors = [
          { 
            id: "1", 
            name: 'SyriaChem', 
            location: 'Damascus Industrial Zone',
            products: 'Industrial chemicals, Solvents',
            color: '#FF5733'
          },
          { 
            id: "2", 
            name: 'MedEast Chemicals', 
            location: 'Latakia Port Area',
            products: 'Pharmaceutical chemicals, Reagents',
            color: '#33FF57'
          }
        ];
        
        data.customers = [
          {
            id: "1",
            name: 'Damascus Pharmaceuticals',
            status: 'active',
            contact: '+963 11 123 4567',
            lat: 33.5138,
            lng: 36.2765,
            competitorIds: ["1"],
            categories: ['paints', 'cosmetics'],
            remarks: 'Interested in our new product line',
            lastVisit: '2023-05-10',
            nextVisit: '2023-06-15',
            addedBy: "1",
            addedOn: '2023-05-10T10:30:00'
          },
          {
            id: "2",
            name: 'Aleppo Medical Supplies',
            status: 'hard',
            contact: '+963 21 987 6543',
            lat: 36.2021,
            lng: 37.1343,
            competitorIds: ["2"],
            categories: ['alkyde'],
            remarks: 'Need to discuss pricing',
            lastVisit: '2023-05-05',
            nextVisit: '2023-06-20',
            addedBy: "1",
            addedOn: '2023-05-05T14:15:00'
          }
        ];
      }
    }
    
    // Initialize map
    function initMap() {
      // Create map centered on Syria
      map = L.map('map').setView([35.0, 38.0], 7);
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Add click event to map for adding customers
      map.on('click', function(e) {
        if (mapMode === 'add') {
          showAddCustomerTooltip(e.latlng);
        }
      });
    }
    
    // Show add customer tooltip
    function showAddCustomerTooltip(latlng) {
      // Close existing tooltip if open
      if (addCustomerTooltip) {
        map.closePopup(addCustomerTooltip);
      }
      
      // Create tooltip content
      const tooltipContent = document.createElement('div');
      tooltipContent.className = 'add-customer-tooltip';
      
      tooltipContent.innerHTML = `
        <div class="title">Add New Customer</div>
        <input type="text" id="quickCustomerName" placeholder="Customer Name" class="mb-2">
        <select id="quickCustomerStatus" class="mb-2">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="hard">Hard</option>
          <option value="potential">Potential</option>
        </select>
        <div class="flex justify-end mt-2">
          <button class="save-btn" id="quickSaveCustomer">Save</button>
          <button class="cancel-btn" id="quickCancelCustomer">Cancel</button>
        </div>
      `;
      
      // Create popup
      addCustomerTooltip = L.popup()
        .setLatLng(latlng)
        .setContent(tooltipContent)
        .openOn(map);
      
      // Add event listeners
      setTimeout(() => {
        document.getElementById('quickSaveCustomer').addEventListener('click', function() {
          const name = document.getElementById('quickCustomerName').value.trim();
          const status = document.getElementById('quickCustomerStatus').value;
          
          if (!name) {
            alert('Please enter a customer name');
            return;
          }
          
          // Create customer data
          const customerData = {
            name: name,
            status: status,
            contact: '',
            lat: latlng.lat,
            lng: latlng.lng,
            competitorIds: [],
            categories: [],
            remarks: '',
            lastVisit: null,
            nextVisit: null,
            addedBy: currentUser.id,
            addedOn: new Date().toISOString()
          };
          
          // Save customer
          saveQuickCustomer(customerData);
        });
        
        document.getElementById('quickCancelCustomer').addEventListener('click', function() {
          map.closePopup(addCustomerTooltip);
          addCustomerTooltip = null;
        });
      }, 100);
    }
    
    // Save quick customer
    async function saveQuickCustomer(customerData) {
      try {
        // Save to Firebase
        const docRef = await window.firestoreAddDoc(window.firestoreCollection(window.db, 'customers'), customerData);
        
        // Add to local data
        data.customers.push({
          id: docRef.id,
          ...customerData
        });
        
        // Close tooltip
        map.closePopup(addCustomerTooltip);
        addCustomerTooltip = null;
        
        // Refresh markers
        refreshMarkers();
        
        // Show confirmation
        alert('Customer added successfully');
      } catch (error) {
        console.error("Error saving customer:", error);
        alert('Error saving customer. Please try again.');
      }
    }
    
    // Set map mode
    function setMapMode(mode) {
      mapMode = mode;
      
      // Update button styles
      if (mode === 'view') {
        document.getElementById('viewModeBtn').classList.add('active');
        document.getElementById('addModeBtn').classList.remove('active');
        map.getContainer().style.cursor = '';
      } else {
        document.getElementById('viewModeBtn').classList.remove('active');
        document.getElementById('addModeBtn').classList.add('active');
        map.getContainer().style.cursor = 'crosshair';
      }
      
      // Close any open tooltip
      if (addCustomerTooltip) {
        map.closePopup(addCustomerTooltip);
        addCustomerTooltip = null;
      }
    }
    
    // Refresh map markers
    function refreshMarkers() {
      // Clear existing markers
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
      
      // Get filter values
      const statusFilter = document.getElementById('mapStatusFilter').value;
      const categoryFilter = document.getElementById('mapCategoryFilter').value;
      const competitorFilter = document.getElementById('mapCompetitorFilter').value;
      
      // Add customer markers
      data.customers.forEach(customer => {
        // Apply filters
        if (statusFilter !== 'all' && customer.status !== statusFilter) return;
        if (categoryFilter !== 'all' && !customer.categories.includes(categoryFilter)) return;
        if (competitorFilter !== 'all' && !customer.competitorIds.includes(competitorFilter)) return;
        
        // Create marker
        const markerHtml = `<div class="custom-marker status-${customer.status}">${customer.name.charAt(0)}</div>`;
        const icon = L.divIcon({
          html: markerHtml,
          className: '',
          iconSize: [30, 30]
        });
        
        const marker = L.marker([customer.lat, customer.lng], { icon: icon });
        
        // Create popup content
        let popupContent = `
          <div class="p-2">
            <h3 class="font-bold">${customer.name}</h3>
            <p class="text-sm mb-1">Status: <span class="font-medium">${customer.status.charAt(0).toUpperCase() + customer.status.slice(1)}</span></p>
            <p class="text-sm mb-1">Contact: <span class="font-medium">${customer.contact || 'N/A'}</span></p>
            <p class="text-sm mb-1">Categories: <span class="font-medium">${customer.categories.join(', ') || 'N/A'}</span></p>
            <p class="text-sm mb-2">Competitors: <span class="font-medium">${getCompetitorNames(customer.competitorIds).join(', ') || 'None'}</span></p>
            <div class="flex space-x-2 mt-2">
              <button class="edit-customer-btn bg-blue-600 text-white py-1 px-2 rounded text-xs" data-id="${customer.id}">Edit</button>
        `;
        
        // Only show delete button for admins
        if (currentUser && currentUser.role === 'admin') {
          popupContent += `<button class="delete-customer-btn bg-red-600 text-white py-1 px-2 rounded text-xs" data-id="${customer.id}">Delete</button>`;
        }
        
        popupContent += `
            </div>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        
        // Add event listeners to popup buttons
        marker.on('popupopen', function() {
          document.querySelector('.edit-customer-btn').addEventListener('click', function(e) {
            const customerId = e.target.getAttribute('data-id');
            editCustomer(customerId);
            map.closePopup();
          });
          
          const deleteBtn = document.querySelector('.delete-customer-btn');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', function(e) {
              const customerId = e.target.getAttribute('data-id');
              deleteCustomer(customerId);
              map.closePopup();
            });
          }
        });
        
        marker.addTo(map);
        markers.push(marker);
      });
      
      // Refresh competitor markers
      refreshCompetitorMarkers();
      
      // Refresh salesperson markers
      refreshSalespersonMarkers();
    }
    
    // Refresh competitor markers
    function refreshCompetitorMarkers() {
      // Clear existing competitor markers
      competitorMarkers.forEach(marker => map.removeLayer(marker));
      competitorMarkers = [];
      
      // Check if competitors should be shown
      if (!document.getElementById('showCompetitors').checked) {
        return;
      }
      
      // Add competitor markers
      data.competitors.forEach(competitor => {
        // Find customers associated with this competitor
        const associatedCustomers = data.customers.filter(customer => 
          customer.competitorIds && customer.competitorIds.includes(competitor.id)
        );
        
        // Skip if no associated customers
        if (associatedCustomers.length === 0) {
          return;
        }
        
        // Calculate average position
        let avgLat = 0;
        let avgLng = 0;
        
        associatedCustomers.forEach(customer => {
          avgLat += customer.lat;
          avgLng += customer.lng;
        });
        
        avgLat /= associatedCustomers.length;
        avgLng /= associatedCustomers.length;
        
        // Create marker
        const markerHtml = `<div class="competitor-marker" style="background-color: ${competitor.color};"></div>`;
        const icon = L.divIcon({
          html: markerHtml,
          className: '',
          iconSize: [20, 20]
        });
        
        const marker = L.marker([avgLat, avgLng], { icon: icon });
        
        // Create popup content
        const popupContent = `
          <div class="p-2">
            <h3 class="font-bold">${competitor.name}</h3>
            <p class="text-sm mb-1">Location: <span class="font-medium">${competitor.location || 'N/A'}</span></p>
            <p class="text-sm mb-1">Products: <span class="font-medium">${competitor.products || 'N/A'}</span></p>
            <p class="text-sm mb-2">Customers: <span class="font-medium">${associatedCustomers.length}</span></p>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        marker.addTo(map);
        competitorMarkers.push(marker);
      });
    }
    
    // Refresh salesperson markers
    function refreshSalespersonMarkers() {
      // Clear existing salesperson markers
      salespersonMarkers.forEach(marker => map.removeLayer(marker));
      salespersonMarkers = [];
      
      // Check if salespersons should be shown
      if (!document.getElementById('showSalespersons').checked) {
        return;
      }
      
      // Add salesperson markers
      data.users.forEach(user => {
        if (user.role !== 'salesperson' || !user.tracking || user.tracking.length === 0) {
          return;
        }
        
        // Get latest tracking data
        const latestTracking = user.tracking[user.tracking.length - 1];
        
        // Create marker
        const markerHtml = `<div class="salesperson-marker">${user.fullName.charAt(0)}</div>`;
        const icon = L.divIcon({
          html: markerHtml,
          className: '',
          iconSize: [25, 25]
        });
        
        const marker = L.marker([latestTracking.lat, latestTracking.lng], { icon: icon });
        
        // Create popup content
        const popupContent = `
          <div class="p-2">
            <h3 class="font-bold">${user.fullName}</h3>
            <p class="text-sm mb-1">Status: <span class="font-medium">${latestTracking.status || 'Active'}</span></p>
            <p class="text-sm mb-1">Last Update: <span class="font-medium">${formatDateTime(latestTracking.timestamp)}</span></p>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        marker.addTo(map);
        salespersonMarkers.push(marker);
      });
    }
    
    // Get competitor names from IDs
    function getCompetitorNames(competitorIds) {
      if (!competitorIds || competitorIds.length === 0) {
        return [];
      }
      
      return competitorIds.map(id => {
        const competitor = data.competitors.find(c => c.id === id);
        return competitor ? competitor.name : 'Unknown';
      });
    }
    
    // Format date and time
    function formatDateTime(dateTimeString) {
      if (!dateTimeString) return 'N/A';
      
      const date = new Date(dateTimeString);
      return date.toLocaleString();
    }
    
    // Format date only
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      
      const date = new Date(dateString);
      return date.toLocaleDateString();
    }
    
    // Render customers table
    function renderCustomers() {
      const tableBody = document.getElementById('customerTableBody');
      tableBody.innerHTML = '';
      
      // Get filter values
      const statusFilter = document.getElementById('customerStatusFilter').value;
      const categoryFilter = document.getElementById('customerCategoryFilter').value;
      const competitorFilter = document.getElementById('customerCompetitorFilter').value;
      
      // Filter customers
      const filteredCustomers = data.customers.filter(customer => {
        if (statusFilter !== 'all' && customer.status !== statusFilter) return false;
        if (categoryFilter !== 'all' && !customer.categories.includes(categoryFilter)) return false;
        if (competitorFilter !== 'all' && !customer.competitorIds.includes(competitorFilter)) return false;
        return true;
      });
      
      // Add rows
      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        
        // Create status badge
        let statusClass = '';
        switch (customer.status) {
          case 'active':
            statusClass = 'bg-green-100 text-green-800';
            break;
          case 'inactive':
            statusClass = 'bg-gray-100 text-gray-800';
            break;
          case 'hard':
            statusClass = 'bg-red-100 text-red-800';
            break;
          case 'potential':
            statusClass = 'bg-yellow-100 text-yellow-800';
            break;
        }
        
        const statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${customer.status.charAt(0).toUpperCase() + customer.status.slice(1)}</span>`;
        
        // Create categories list
        const categoriesList = customer.categories && customer.categories.length > 0 ? 
          customer.categories.map(category => 
            `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-1">${category}</span>`
          ).join('') : 'None';
        
        // Create competitors list
        const competitorsList = customer.competitorIds && customer.competitorIds.length > 0 ?
          getCompetitorNames(customer.competitorIds).map(name => 
            `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 mr-1">${name}</span>`
          ).join('') : 'None';
        
        // Create action buttons
        let actionButtons = `
          <button class="edit-customer-btn bg-blue-600 text-white py-1 px-2 rounded text-xs mr-2" data-id="${customer.id}">Edit</button>
        `;
        
        // Only show delete button for admins
        if (currentUser && currentUser.role === 'admin') {
          actionButtons += `<button class="delete-customer-btn bg-red-600 text-white py-1 px-2 rounded text-xs" data-id="${customer.id}">Delete</button>`;
        }
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${customer.name}</div>
            <div class="text-sm text-gray-500">${customer.contact || ''}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${statusBadge}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex flex-wrap gap-1">${categoriesList}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex flex-wrap gap-1">${competitorsList}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${formatDate(customer.lastVisit)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${formatDate(customer.nextVisit)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right">
            <div class="flex justify-end">
              ${actionButtons}
            </div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.edit-customer-btn').forEach(button => {
        button.addEventListener('click', function() {
          const customerId = this.getAttribute('data-id');
          editCustomer(customerId);
        });
      });
      
      document.querySelectorAll('.delete-customer-btn').forEach(button => {
        button.addEventListener('click', function() {
          const customerId = this.getAttribute('data-id');
          deleteCustomer(customerId);
        });
      });
    }
    
    // Render competitors table
    function renderCompetitors() {
      const tableBody = document.getElementById('competitorTableBody');
      tableBody.innerHTML = '';
      
      data.competitors.forEach(competitor => {
        const row = document.createElement('tr');
        
        // Create color swatch
        const colorSwatch = `<div class="w-6 h-6 rounded-full" style="background-color: ${competitor.color};"></div>`;
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${competitor.name}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-500">${competitor.location || 'N/A'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-500">${competitor.products || 'N/A'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${colorSwatch}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right">
            <button class="edit-competitor-btn bg-blue-600 text-white py-1 px-2 rounded text-xs mr-2" data-id="${competitor.id}">Edit</button>
            <button class="delete-competitor-btn bg-red-600 text-white py-1 px-2 rounded text-xs" data-id="${competitor.id}">Delete</button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.edit-competitor-btn').forEach(button => {
        button.addEventListener('click', function() {
          const competitorId = this.getAttribute('data-id');
          editCompetitor(competitorId);
        });
      });
      
      document.querySelectorAll('.delete-competitor-btn').forEach(button => {
        button.addEventListener('click', function() {
          const competitorId = this.getAttribute('data-id');
          deleteCompetitor(competitorId);
        });
      });
    }
    
    // Render users table
    function renderUsers() {
      const tableBody = document.getElementById('userTableBody');
      tableBody.innerHTML = '';
      
      data.users.forEach(user => {
        const row = document.createElement('tr');
        
        // Create role badge
        let roleClass = user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';
        const roleBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${roleClass}">${user.role === 'admin' ? 'Administrator' : 'Salesperson'}</span>`;
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${user.fullName}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-500">${user.username}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${roleBadge}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right">
            <button class="edit-user-btn bg-blue-600 text-white py-1 px-2 rounded text-xs mr-2" data-id="${user.id}">Edit</button>
            <button class="delete-user-btn bg-red-600 text-white py-1 px-2 rounded text-xs" data-id="${user.id}">Delete</button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.edit-user-btn').forEach(button => {
        button.addEventListener('click', function() {
          const userId = this.getAttribute('data-id');
          editUser(userId);
        });
      });
      
      document.querySelectorAll('.delete-user-btn').forEach(button => {
        button.addEventListener('click', function() {
          const userId = this.getAttribute('data-id');
          deleteUser(userId);
        });
      });
    }
    
    // Render salespersons table
    function renderSalespersons() {
      const tableBody = document.getElementById('salespersonTableBody');
      tableBody.innerHTML = '';
      
      const salespersons = data.users.filter(user => user.role === 'salesperson');
      
      salespersons.forEach(user => {
        const row = document.createElement('tr');
        
        // Get latest tracking data
        let lastActive = 'Never';
        let status = 'Inactive';
        
        if (user.tracking && user.tracking.length > 0) {
          const latestTracking = user.tracking[user.tracking.length - 1];
          lastActive = formatDateTime(latestTracking.timestamp);
          status = latestTracking.status || 'Active';
        }
        
        // Count customers added by this salesperson
        const customerCount = data.customers.filter(customer => customer.addedBy === user.id).length;
        
        // Create status badge
        let statusClass = status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
        const statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${status}</span>`;
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${user.fullName}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-500">${lastActive}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${statusBadge}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${customerCount}</div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
    }
    
    // Update competitor checkboxes
    function updateCompetitorCheckboxes() {
      const container = document.getElementById('competitorCheckboxes');
      container.innerHTML = '';
      
      data.competitors.forEach(competitor => {
        const label = document.createElement('label');
        label.className = 'inline-flex items-center';
        
        label.innerHTML = `
          <input type="checkbox" value="${competitor.id}" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
          <span class="ml-2 text-sm text-gray-700">${competitor.name}</span>
        `;
        
        container.appendChild(label);
      });
    }
    
    // Update filter dropdowns
    function updateFilterDropdowns() {
      const mapCompetitorFilter = document.getElementById('mapCompetitorFilter');
      const customerCompetitorFilter = document.getElementById('customerCompetitorFilter');
      
      // Clear existing options except the first one
      while (mapCompetitorFilter.options.length > 1) {
        mapCompetitorFilter.remove(1);
      }
      
      while (customerCompetitorFilter.options.length > 1) {
        customerCompetitorFilter.remove(1);
      }
      
      // Add competitor options
      data.competitors.forEach(competitor => {
        const option1 = document.createElement('option');
        option1.value = competitor.id;
        option1.textContent = competitor.name;
        mapCompetitorFilter.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = competitor.id;
        option2.textContent = competitor.name;
        customerCompetitorFilter.appendChild(option2);
      });
    }
    
    // Edit customer
    function editCustomer(customerId) {
      const customer = data.customers.find(c => c.id === customerId);
      if (!customer) return;
      
      // Set form title
      document.getElementById('customerFormTitle').textContent = 'Edit Customer';
      
      // Fill form fields
      document.getElementById('customerId').value = customer.id;
      document.getElementById('customerName').value = customer.name;
      document.getElementById('customerStatus').value = customer.status;
      document.getElementById('customerContact').value = customer.contact || '';
      document.getElementById('customerLat').value = customer.lat;
      document.getElementById('customerLng').value = customer.lng;
      document.getElementById('customerRemarks').value = customer.remarks || '';
      document.getElementById('lastVisitDate').value = customer.lastVisit || '';
      document.getElementById('nextVisitDate').value = customer.nextVisit || '';
      
      // Check category checkboxes
      document.querySelectorAll('input[name="customerCategory"]').forEach(checkbox => {
        checkbox.checked = customer.categories && customer.categories.includes(checkbox.value);
      });
      
      // Check competitor checkboxes
      document.querySelectorAll('#competitorCheckboxes input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = customer.competitorIds && customer.competitorIds.includes(checkbox.value);
      });
      
      // Show form
      document.getElementById('customerForm').classList.remove('hidden');
      
      // Switch to customers tab
      switchTab('customers-tab');
    }
    
    // Delete customer
    async function deleteCustomer(id) {
      if (confirm('Are you sure you want to delete this customer?')) {
        try {
          // Delete from Firebase
          await window.firestoreDeleteDoc(window.firestoreDoc(window.db, 'customers', id));
          
          // Remove from local data
          const index = data.customers.findIndex(c => c.id === id);
          if (index !== -1) {
            data.customers.splice(index, 1);
          }
          
          // If we're currently editing this customer, reset the form
          if (document.getElementById('customerId').value === id) {
            cancelEdit();
          }
          
          // Update the display
          refreshMarkers();
          renderCustomers();
          
          // Show confirmation
          alert('Customer deleted successfully');
        } catch (error) {
          console.error("Error deleting customer:", error);
          alert('Error deleting customer. Please try again.');
        }
      }
    }
    
    // Edit competitor
    function editCompetitor(competitorId) {
      const competitor = data.competitors.find(c => c.id === competitorId);
      if (!competitor) return;
      
      // Set form title
      document.getElementById('competitorFormTitle').textContent = 'Edit Competitor';
      
      // Fill form fields
      document.getElementById('competitorId').value = competitor.id;
      document.getElementById('competitorName').value = competitor.name;
      document.getElementById('competitorLocation').value = competitor.location || '';
      document.getElementById('competitorProducts').value = competitor.products || '';
      document.getElementById('competitorColor').value = competitor.color;
      
      // Show form
      document.getElementById('competitorForm').classList.remove('hidden');
      
      // Switch to competitors tab
      switchTab('competitors-tab');
    }
    
    // Delete competitor
    async function deleteCompetitor(id) {
      // Check if competitor is used by any customers
      const usedByCustomers = data.customers.some(customer => 
        customer.competitorIds && customer.competitorIds.includes(id)
      );
      
      if (usedByCustomers) {
        alert('This competitor cannot be deleted because it is used by one or more customers.');
        return;
      }
      
      if (confirm('Are you sure you want to delete this competitor?')) {
        try {
          // Delete from Firebase
          await window.firestoreDeleteDoc(window.firestoreDoc(window.db, 'competitors', id));
          
          // Remove from local data
          const index = data.competitors.findIndex(c => c.id === id);
          if (index !== -1) {
            data.competitors.splice(index, 1);
          }
          
          // If we're currently editing this competitor, reset the form
          if (document.getElementById('competitorId').value === id) {
            cancelCompetitorEdit();
          }
          
          // Update the display
          renderCompetitors();
          updateCompetitorCheckboxes();
          updateFilterDropdowns();
          refreshMarkers();
          
          // Show confirmation
          alert('Competitor deleted successfully');
        } catch (error) {
          console.error("Error deleting competitor:", error);
          alert('Error deleting competitor. Please try again.');
        }
      }
    }
    
    // Edit user
    function editUser(userId) {
      const user = data.users.find(u => u.id === userId);
      if (!user) return;
      
      // Set form title
      document.getElementById('userFormTitle').textContent = 'Edit User';
      
      // Fill form fields
      document.getElementById('userId').value = user.id;
      document.getElementById('userFullName').value = user.fullName;
      document.getElementById('userUsername').value = user.username;
      document.getElementById('userPassword').value = ''; // Don't show password
      document.getElementById('userRole').value = user.role;
      
      // Show form
      document.getElementById('userForm').classList.remove('hidden');
      
      // Switch to users tab
      switchTab('users-tab');
    }
    
    // Delete user
    async function deleteUser(id) {
      // Check if user is the current user
      if (currentUser && currentUser.id === id) {
        alert('You cannot delete your own account.');
        return;
      }
      
      // Check if user is the last admin
      const admins = data.users.filter(user => user.role === 'admin');
      if (admins.length === 1 && admins[0].id === id) {
        alert('Cannot delete the last administrator account.');
        return;
      }
      
      if (confirm('Are you sure you want to delete this user?')) {
        try {
          // Delete from Firebase
          await window.firestoreDeleteDoc(window.firestoreDoc(window.db, 'users', id));
          
          // Remove from local data
          const index = data.users.findIndex(u => u.id === id);
          if (index !== -1) {
            data.users.splice(index, 1);
          }
          
          // If we're currently editing this user, reset the form
          if (document.getElementById('userId').value === id) {
            cancelUserEdit();
          }
          
          // Update the display
          renderUsers();
          renderSalespersons();
          refreshMarkers();
          
          // Show confirmation
          alert('User deleted successfully');
        } catch (error) {
          console.error("Error deleting user:", error);
          alert('Error deleting user. Please try again.');
        }
      }
    }
    
    // Save customer
    async function saveCustomer() {
      // Get form values
      const customerId = document.getElementById('customerId').value;
      const name = document.getElementById('customerName').value.trim();
      const status = document.getElementById('customerStatus').value;
      const contact = document.getElementById('customerContact').value.trim();
      const lat = parseFloat(document.getElementById('customerLat').value);
      const lng = parseFloat(document.getElementById('customerLng').value);
      const remarks = document.getElementById('customerRemarks').value.trim();
      const lastVisit = document.getElementById('lastVisitDate').value;
      const nextVisit = document.getElementById('nextVisitDate').value;
      
      // Get selected competitors
      const competitorIds = [];
      const competitorCheckboxes = document.querySelectorAll('#competitorCheckboxes input[type="checkbox"]:checked');
      competitorCheckboxes.forEach(checkbox => {
        competitorIds.push(checkbox.value);
      });
      
      // Get selected categories
      const categories = [];
      const categoryCheckboxes = document.querySelectorAll('input[name="customerCategory"]:checked');
      categoryCheckboxes.forEach(checkbox => {
        categories.push(checkbox.value);
      });
      
      // Basic validation
      if (!name) {
        alert('Please enter a customer name');
        return;
      }
      
      if (isNaN(lat) || isNaN(lng)) {
        alert('Please enter valid coordinates');
        return;
      }
      
      // Create customer data
      const customerData = {
        name: name,
        status: status,
        contact: contact,
        lat: lat,
        lng: lng,
        competitorIds: competitorIds,
        categories: categories,
        remarks: remarks,
        lastVisit: lastVisit || null,
        nextVisit: nextVisit || null
      };
      
      try {
        // Check if editing or creating new
        if (customerId) {
          // Update existing customer
          await window.firestoreUpdateDoc(window.firestoreDoc(window.db, 'customers', customerId), customerData);
          
          // Update local data
          const index = data.customers.findIndex(c => c.id === customerId);
          if (index !== -1) {
            // Preserve addedBy and addedOn
            customerData.addedBy = data.customers[index].addedBy;
            customerData.addedOn = data.customers[index].addedOn;
            
            data.customers[index] = {
              id: customerId,
              ...customerData
            };
          }
          
          // Reset form
          cancelEdit();
        } else {
          // Add addedBy and addedOn for new customer
          customerData.addedBy = currentUser.id;
          customerData.addedOn = new Date().toISOString();
          
          // Create new customer
          const docRef = await window.firestoreAddDoc(window.firestoreCollection(window.db, 'customers'), customerData);
          
          // Add to local data
          data.customers.push({
            id: docRef.id,
            ...customerData
          });
          
          // Reset form
          cancelEdit();
        }
        
        // Refresh display
        refreshMarkers();
        renderCustomers();
        
        // Show confirmation
        alert('Customer saved successfully');
      } catch (error) {
        console.error("Error saving customer:", error);
        alert('Error saving customer. Please try again.');
      }
    }
    
    // Save competitor
    async function saveCompetitor() {
      // Get form values
      const competitorId = document.getElementById('competitorId').value;
      const name = document.getElementById('competitorName').value.trim();
      const location = document.getElementById('competitorLocation').value.trim();
      const products = document.getElementById('competitorProducts').value.trim();
      const color = document.getElementById('competitorColor').value;
      
      // Basic validation
      if (!name) {
        alert('Please enter a competitor name');
        return;
      }
      
      // Create competitor data
      const competitorData = {
        name: name,
        location: location,
        products: products,
        color: color
      };
      
      try {
        // Check if editing or creating new
        if (competitorId) {
          // Update existing competitor
          await window.firestoreUpdateDoc(window.firestoreDoc(window.db, 'competitors', competitorId), competitorData);
          
          // Update local data
          const index = data.competitors.findIndex(c => c.id === competitorId);
          if (index !== -1) {
            data.competitors[index] = {
              id: competitorId,
              ...competitorData
            };
          }
        } else {
          // Create new competitor
          const docRef = await window.firestoreAddDoc(window.firestoreCollection(window.db, 'competitors'), competitorData);
          
          // Add to local data
          data.competitors.push({
            id: docRef.id,
            ...competitorData
          });
        }
        
        // Reset form
        cancelCompetitorEdit();
        
        // Update the display
        renderCompetitors();
        updateCompetitorCheckboxes();
        updateFilterDropdowns();
        refreshMarkers();
        
        // Show confirmation
        alert('Competitor saved successfully');
      } catch (error) {
        console.error("Error saving competitor:", error);
        alert('Error saving competitor. Please try again.');
      }
    }
    
    // Save user
    async function saveUser() {
      // Get form values
      const userId = document.getElementById('userId').value;
      const fullName = document.getElementById('userFullName').value.trim();
      const username = document.getElementById('userUsername').value.trim();
      const password = document.getElementById('userPassword').value;
      const role = document.getElementById('userRole').value;
      
      // Basic validation
      if (!fullName || !username) {
        alert('Please enter full name and username');
        return;
      }
      
      // Create user data
      const userData = {
        fullName: fullName,
        username: username,
        role: role
      };
      
      // Add password if provided
      if (password) {
        userData.password = password;
      }
      
      try {
        // Check if editing or creating new
        if (userId) {
          // Update existing user
          await window.firestoreUpdateDoc(window.firestoreDoc(window.db, 'users', userId), userData);
          
          // Update local data
          const index = data.users.findIndex(u => u.id === userId);
          if (index !== -1) {
            // Preserve tracking data if it exists
            if (data.users[index].tracking) {
              userData.tracking = data.users[index].tracking;
            }
            
            // Preserve password if not changed
            if (!password) {
              userData.password = data.users[index].password;
            }
            
            data.users[index] = {
              id: userId,
              ...userData
            };
            
            // Update current user if editing self
            if (currentUser && currentUser.id === userId) {
              currentUser = data.users[index];
              localStorage.setItem('currentUser', JSON.stringify(currentUser));
              
              // Update display
              document.getElementById('currentUserDisplay').textContent = currentUser.fullName;
              
              const roleBadge = document.getElementById('userRoleBadge');
              roleBadge.textContent = currentUser.role === 'admin' ? 'Administrator' : 'Salesperson';
              roleBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium';
              
              if (currentUser.role === 'admin') {
                roleBadge.classList.add('bg-purple-100', 'text-purple-800');
                document.getElementById('adminOnlySection').classList.remove('hidden');
                document.getElementById('exportDiv').classList.remove('hidden');
                document.getElementById('adminOnlyTab').classList.remove('hidden');
              } else {
                roleBadge.classList.add('bg-blue-100', 'text-blue-800');
                document.getElementById('adminOnlySection').classList.add('hidden');
                document.getElementById('exportDiv').classList.add('hidden');
                document.getElementById('adminOnlyTab').classList.add('hidden');
              }
            }
          }
        } else {
          // Create new user
          const docRef = await window.firestoreAddDoc(window.firestoreCollection(window.db, 'users'), userData);
          
          // Add to local data
          data.users.push({
            id: docRef.id,
            ...userData
          });
        }
        
        // Reset form
        cancelUserEdit();
        
        // Update the display
        renderUsers();
        renderSalespersons();
        
        // Show confirmation
        alert('User saved successfully');
      } catch (error) {
        console.error("Error saving user:", error);
        alert('Error saving user. Please try again.');
      }
    }
    
    // Cancel customer edit
    function cancelEdit() {
      document.getElementById('customerId').value = '';
      document.getElementById('customerName').value = '';
      document.getElementById('customerContact').value = '';
      document.getElementById('customerLat').value = '';
      document.getElementById('customerLng').value = '';
      document.getElementById('customerRemarks').value = '';
      document.getElementById('lastVisitDate').value = '';
      document.getElementById('nextVisitDate').value = '';
      
      // Reset status to active
      document.getElementById('customerStatus').value = 'active';
      
      // Uncheck all checkboxes
      document.querySelectorAll('#competitorCheckboxes input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      document.querySelectorAll('input[name="customerCategory"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Reset form title
      document.getElementById('customerFormTitle').textContent = 'Add New Customer';
      
      // Hide form
      document.getElementById('customerForm').classList.add('hidden');
    }
    
    // Cancel competitor edit
    function cancelCompetitorEdit() {
      document.getElementById('competitorId').value = '';
      document.getElementById('competitorName').value = '';
      document.getElementById('competitorLocation').value = '';
      document.getElementById('competitorProducts').value = '';
      document.getElementById('competitorColor').value = '#FF5733';
      
      // Reset form title
      document.getElementById('competitorFormTitle').textContent = 'Add New Competitor';
      
      // Hide form
      document.getElementById('competitorForm').classList.add('hidden');
    }
    
    // Cancel user edit
    function cancelUserEdit() {
      document.getElementById('userId').value = '';
      document.getElementById('userFullName').value = '';
      document.getElementById('userUsername').value = '';
      document.getElementById('userPassword').value = '';
      document.getElementById('userRole').value = 'admin';
      
      // Reset form title
      document.getElementById('userFormTitle').textContent = 'Add New User';
      
      // Hide form
      document.getElementById('userForm').classList.add('hidden');
    }
    
    // Export customers to CSV
    function exportCustomersToCSV() {
      // Get filter values
      const statusFilter = document.getElementById('customerStatusFilter').value;
      const categoryFilter = document.getElementById('customerCategoryFilter').value;
      const competitorFilter = document.getElementById('customerCompetitorFilter').value;
      
      // Filter customers
      const filteredCustomers = data.customers.filter(customer => {
        if (statusFilter !== 'all' && customer.status !== statusFilter) return false;
        if (categoryFilter !== 'all' && !customer.categories.includes(categoryFilter)) return false;
        if (competitorFilter !== 'all' && !customer.competitorIds.includes(competitorFilter)) return false;
        return true;
      });
      
      // Create CSV content
      let csvContent = 'Name,Status,Contact,Latitude,Longitude,Categories,Competitors,Remarks,Last Visit,Next Visit\n';
      
      filteredCustomers.forEach(customer => {
        const categories = customer.categories ? customer.categories.join('; ') : '';
        const competitors = getCompetitorNames(customer.competitorIds).join('; ');
        
        // Escape fields that might contain commas
        const escapeCsv = (str) => {
          if (!str) return '';
          return `"${str.replace(/"/g, '""')}"`;
        };
        
        csvContent += [
          escapeCsv(customer.name),
          customer.status,
          escapeCsv(customer.contact),
          customer.lat,
          customer.lng,
          escapeCsv(categories),
          escapeCsv(competitors),
          escapeCsv(customer.remarks),
          customer.lastVisit || '',
          customer.nextVisit || ''
        ].join(',') + '\n';
      });
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'customers.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Start tracking for salesperson
    function startTracking() {
      // Check if geolocation is available
      if (!navigator.geolocation) {
        console.log('Geolocation is not supported by your browser');
        return;
      }
      
      // Start tracking interval
      trackingInterval = setInterval(() => {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const trackingData = {
              timestamp: new Date().toISOString(),
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              status: 'Active'
            };
            
            try {
              // Find user in data
              const userIndex = data.users.findIndex(u => u.id === currentUser.id);
              
              if (userIndex !== -1) {
                // Initialize tracking array if it doesn't exist
                if (!data.users[userIndex].tracking) {
                  data.users[userIndex].tracking = [];
                }
                
                // Add tracking data
                data.users[userIndex].tracking.push(trackingData);
                
                // Limit tracking history to last 100 entries
                if (data.users[userIndex].tracking.length > 100) {
                  data.users[userIndex].tracking.shift();
                }
                
                // Update in Firebase
                await window.firestoreUpdateDoc(window.firestoreDoc(window.db, 'users', currentUser.id), {
                  tracking: data.users[userIndex].tracking
                });
                
                // Update current user
                currentUser = data.users[userIndex];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                console.log('Location updated');
              }
            } catch (error) {
              console.error('Error updating location:', error);
            }
          },
          (error) => {
            console.error('Error getting location:', error);
          }
        );
      }, 60000); // Update every minute
    }
    
    // Stop tracking
    function stopTracking() {
      if (trackingInterval) {
        clearInterval(trackingInterval);
        trackingInterval = null;
      }
    }
    
    // Switch tab
    function switchTab(tabId) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabId).classList.add('active');
      
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        if (button.getAttribute('data-tab') === tabId) {
          button.classList.add('border-blue-500', 'text-blue-600');
          button.classList.remove('border-transparent', 'text-gray-500');
        } else {
          button.classList.remove('border-blue-500', 'text-blue-600');
          button.classList.add('border-transparent', 'text-gray-500');
        }
      });
    }
    
    // Setup event listeners
    function setupListeners() {
      // Tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          switchTab(tabId);
        });
      });
      
      // Map filters
      document.getElementById('mapStatusFilter').addEventListener('change', refreshMarkers);
      document.getElementById('mapCategoryFilter').addEventListener('change', refreshMarkers);
      document.getElementById('mapCompetitorFilter').addEventListener('change', refreshMarkers);
      document.getElementById('showCompetitors').addEventListener('change', refreshCompetitorMarkers);
      document.getElementById('showSalespersons').addEventListener('change', refreshSalespersonMarkers);
      
      // Map mode buttons
      document.getElementById('viewModeBtn').addEventListener('click', function() {
        setMapMode('view');
      });
      
      document.getElementById('addModeBtn').addEventListener('click', function() {
        setMapMode('add');
      });
      
      // Customer filters
      document.getElementById('customerStatusFilter').addEventListener('change', renderCustomers);
      document.getElementById('customerCategoryFilter').addEventListener('change', renderCustomers);
      document.getElementById('customerCompetitorFilter').addEventListener('change', renderCustomers);
      
      // Customer form buttons
      document.getElementById('addCustomerButton').addEventListener('click', function() {
        document.getElementById('customerForm').classList.remove('hidden');
      });
      
      document.getElementById('cancelCustomerButton').addEventListener('click', cancelEdit);
      document.getElementById('saveCustomerButton').addEventListener('click', saveCustomer);
      
      // Competitor form buttons
      document.getElementById('addCompetitorButton').addEventListener('click', function() {
        document.getElementById('competitorForm').classList.remove('hidden');
      });
      
      document.getElementById('cancelCompetitorButton').addEventListener('click', cancelCompetitorEdit);
      document.getElementById('saveCompetitorButton').addEventListener('click', saveCompetitor);
      
      // User form buttons
      document.getElementById('addUserButton').addEventListener('click', function() {
        document.getElementById('userForm').classList.remove('hidden');
      });
      
      document.getElementById('cancelUserButton').addEventListener('click', cancelUserEdit);
      document.getElementById('saveUserButton').addEventListener('click', saveUser);
      
      // Export button
      document.getElementById('exportCustomersButton').addEventListener('click', exportCustomersToCSV);
      
      // Logout button
      document.getElementById('logoutButton').addEventListener('click', logout);
    }
    
    // Setup login listeners
    function setupLoginListeners() {
      document.getElementById('loginButton').addEventListener('click', login);
      
      // Allow login with Enter key
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          login();
        }
      });
    }
    
    // Login function
    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        document.getElementById('loginError').textContent = 'Please enter username and password';
        document.getElementById('loginError').classList.remove('hidden');
        return;
      }
      
      try {
        // Load users if not loaded yet
        if (data.users.length === 0) {
          await loadFromFirebase();
        }
        
        // Find user
        const user = data.users.find(u => u.username === username && u.password === password);
        
        if (user) {
          currentUser = user;
          loginSuccess();
        } else {
          document.getElementById('loginError').textContent = 'Invalid username or password';
          document.getElementById('loginError').classList.remove('hidden');
        }
      } catch (error) {
        console.error("Login error:", error);
        document.getElementById('loginError').textContent = 'An error occurred. Please try again.';
        document.getElementById('loginError').classList.remove('hidden');
      }
    }
    
    // Login success
    async function loginSuccess() {
      isAuthenticated = true;
      localStorage.setItem('isAuthenticated', 'true');
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      
      document.getElementById('loginOverlay').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      // Set user display
      document.getElementById('currentUserDisplay').textContent = currentUser.fullName;
      
      // Set role badge
      const roleBadge = document.getElementById('userRoleBadge');
      if (currentUser.role === 'admin') {
        roleBadge.textContent = 'Administrator';
        roleBadge.classList.add('bg-purple-100', 'text-purple-800');
        document.getElementById('adminOnlySection').classList.remove('hidden');
        document.getElementById('exportDiv').classList.remove('hidden');
        document.getElementById('adminOnlyTab').classList.remove('hidden');
      } else {
        roleBadge.textContent = 'Salesperson';
        roleBadge.classList.add('bg-blue-100', 'text-blue-800');
        document.getElementById('adminOnlySection').classList.add('hidden');
        document.getElementById('exportDiv').classList.add('hidden');
        document.getElementById('adminOnlyTab').classList.add('hidden');
      }
      
      // Initialize the app
      initMap();
      await loadFromFirebase(); // Load data from Firebase
      setupListeners();
      updateCompetitorCheckboxes();
      updateFilterDropdowns();
      renderCustomers();
      renderCompetitors();
      refreshMarkers();
      
      if (currentUser.role === 'admin') {
        renderUsers();
        renderSalespersons();
      }
      
      // Start tracking for salespersons
      if (currentUser.role === 'salesperson') {
        startTracking();
      }
    }
    
    // Logout function
    function logout() {
      isAuthenticated = false;
      currentUser = null;
      localStorage.removeItem('isAuthenticated');
      localStorage.removeItem('currentUser');
      
      // Stop tracking if active
      stopTracking();
      
      // Reset forms
      cancelEdit();
      cancelCompetitorEdit();
      cancelUserEdit();
      
      // Show login overlay
      document.getElementById('loginOverlay').classList.remove('hidden');
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('loginError').classList.add('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      setupLoginListeners();
      
      // Wait for Firebase to be ready
      if (window.firebaseReady) {
        initializeApp();
      } else {
        document.addEventListener('firebase-ready', initializeApp);
      }
    });
    
    function initializeApp() {
      // Check if already logged in
      const savedAuth = localStorage.getItem('isAuthenticated');
      const savedUser = localStorage.getItem('currentUser');
      if (savedAuth === 'true' && savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          loginSuccess();
        } catch (e) {
          console.error("Error parsing saved user:", e);
          logout();
        }
      }
    }
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96655b8961ae5457',t:'MTc1MzcxNTk5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
