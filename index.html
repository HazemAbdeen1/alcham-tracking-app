<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Al Cham Chemical Plant - Territory Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
  
  <style>
    #map {
      height: 500px;
      width: 100%;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .custom-marker {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      color: white;
      font-weight: bold;
      border: 2px solid white;
    }
    .status-active {
      background-color: #10B981;
    }
    .status-inactive {
      background-color: #6B7280;
    }
    .status-hard {
      background-color: #EF4444;
    }
    .status-potential {
      background-color: #F59E0B;
    }
    .competitor-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid white;
      background-color: #EF4444;
    }
    .salesperson-marker {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid white;
      background-color: #3B82F6;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .toast.show {
      opacity: 1;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .map-mode-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 5px;
    }
    .map-mode-toggle button {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    .map-mode-toggle button.active {
      background-color: #3B82F6;
      color: white;
    }
    .map-mode-toggle button:not(.active) {
      background-color: #F3F4F6;
      color: #374151;
    }
    .add-customer-tooltip {
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-width: 300px;
    }
    .add-customer-tooltip .title {
      font-weight: bold;
      margin-bottom: 8px;
    }
    .add-customer-tooltip input,
    .add-customer-tooltip select {
      width: 100%;
      margin-bottom: 8px;
      padding: 4px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .add-customer-tooltip button {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .add-customer-tooltip .save-btn {
      background-color: #3B82F6;
      color: white;
      margin-right: 4px;
    }
    .add-customer-tooltip .cancel-btn {
      background-color: #9CA3AF;
      color: white;
    }
    .comment-item {
      border-left: 3px solid #3B82F6;
      padding-left: 10px;
      margin-bottom: 8px;
    }
    .comment-date {
      font-size: 12px;
      color: #6B7280;
    }
    .comment-user {
      font-size: 12px;
      font-weight: 600;
      color: #4B5563;
    }
    .comment-text {
      font-size: 14px;
      margin-top: 2px;
    }
    .location-pulse {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
      }
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
      }
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }
    .location-sharing-active {
      background-color: #10B981;
    }
    .location-sharing-inactive {
      background-color: #6B7280;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Toast Notification -->
  <div id="toast" class="toast">Message</div>

  <!-- Login Overlay -->
  <div id="loginOverlay" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-lg w-96">
      <div class="flex justify-center mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" class="w-16 h-16">
          <path fill="#3882f6" d="M128 24a104 104 0 1 0 104 104A104.11 104.11 0 0 0 128 24Zm0 192a88 88 0 1 1 88-88 88.1 88.1 0 0 1-88 88Z"/>
          <path fill="#3882f6" d="M128 72a56 56 0 0 0 0 112 56 56 0 0 0 0-112Zm0 96a40 40 0 1 1 40-40 40.05 40.05 0 0 1-40 40Z"/>
          <path fill="#3882f6" d="M128 104a24 24 0 1 0 24 24 24 24 0 0 0-24-24Z"/>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-center mb-6">Al Cham Chemical Plant</h2>
      <div class="mb-4">
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
        <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="mb-6">
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <button id="loginButton" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
        Login
      </button>
      <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"></div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="addUserModal" class="modal">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Add New User</h2>
        <button class="close-modal text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div class="mb-4">
        <label for="newUserFullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
        <input type="text" id="newUserFullName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
        <input type="text" id="newUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="newUserPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input type="password" id="newUserPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="newUserRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
        <select id="newUserRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="admin">Administrator</option>
          <option value="salesperson">Salesperson</option>
        </select>
      </div>
      
      <div class="mb-6">
        <label for="newUserStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        <select id="newUserStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
      
      <div class="flex justify-end">
        <button id="saveUserBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
          Save User
        </button>
      </div>
    </div>
  </div>

  <!-- Add Competitor Modal -->
  <div id="addCompetitorModal" class="modal">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Add New Competitor</h2>
        <button class="close-modal text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div class="mb-4">
        <label for="newCompetitorName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input type="text" id="newCompetitorName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="newCompetitorCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        <select id="newCompetitorCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="paints">Paints</option>
          <option value="alkyde">Alkyde</option>
          <option value="cosmetics">Cosmetics</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label for="newCompetitorStrength" class="block text-sm font-medium text-gray-700 mb-1">Strength</label>
        <select id="newCompetitorStrength" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>
      
      <div class="mb-6">
        <label for="newCompetitorLocation" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
        <input type="text" id="newCompetitorLocation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="flex justify-end">
        <button id="saveCompetitorBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
          Save Competitor
        </button>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div id="addCustomerModal" class="modal">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Add New Customer</h2>
        <button class="close-modal text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div class="mb-4">
        <label for="newCustomerName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input type="text" id="newCustomerName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="newCustomerCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        <select id="newCustomerCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="paints">Paints</option>
          <option value="alkyde">Alkyde</option>
          <option value="cosmetics">Cosmetics</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label for="newCustomerStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        <select id="newCustomerStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="hard">Hard</option>
          <option value="potential">Potential</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label for="newCustomerAddress" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
        <input type="text" id="newCustomerAddress" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="newCustomerContact" class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
        <input type="text" id="newCustomerContact" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="newCustomerCompetitor" class="block text-sm font-medium text-gray-700 mb-1">Main Competitor</label>
        <select id="newCustomerCompetitor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">None</option>
          <!-- Competitor options will be added dynamically -->
        </select>
      </div>
      
      <div class="flex justify-end">
        <button id="saveCustomerBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
          Save Customer
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div id="editCustomerModal" class="modal">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Edit Customer</h2>
        <button class="close-modal text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <input type="hidden" id="editCustomerId">
      
      <div class="mb-4">
        <label for="editCustomerName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input type="text" id="editCustomerName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="editCustomerCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        <select id="editCustomerCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="paints">Paints</option>
          <option value="alkyde">Alkyde</option>
          <option value="cosmetics">Cosmetics</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label for="editCustomerStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        <select id="editCustomerStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="hard">Hard</option>
          <option value="potential">Potential</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label for="editCustomerAddress" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
        <input type="text" id="editCustomerAddress" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="editCustomerContact" class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
        <input type="text" id="editCustomerContact" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-4">
        <label for="editCustomerCompetitor" class="block text-sm font-medium text-gray-700 mb-1">Main Competitor</label>
        <select id="editCustomerCompetitor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">None</option>
          <!-- Competitor options will be added dynamically -->
        </select>
      </div>
      
      <div class="mb-4">
        <label for="editCustomerNextVisit" class="block text-sm font-medium text-gray-700 mb-1">Next Visit Date</label>
        <input type="date" id="editCustomerNextVisit" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="mb-6">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Comments</h3>
        <div id="customerComments" class="max-h-40 overflow-y-auto mb-4 p-2 bg-gray-50 rounded-md">
          <!-- Comments will be added here dynamically -->
          <div class="text-sm text-gray-500 italic">No comments yet</div>
        </div>
        
        <div class="flex items-start">
          <div class="flex-grow">
            <textarea id="newComment" rows="2" placeholder="Add a comment..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <button id="addCommentBtn" class="ml-2 mt-1 bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Add
          </button>
        </div>
      </div>
      
      <div class="flex justify-end">
        <button id="updateCustomerBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
          Update Customer
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" style="display: none;">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" class="w-10 h-10 mr-2">
            <path fill="#3882f6" d="M128 24a104 104 0 1 0 104 104A104.11 104.11 0 0 0 128 24Zm0 192a88 88 0 1 1 88-88 88.1 88.1 0 0 1-88 88Z"/>
            <path fill="#3882f6" d="M128 72a56 56 0 0 0 0 112 56 56 0 0 0 0-112Zm0 96a40 40 0 1 1 40-40 40.05 40.05 0 0 1-40 40Z"/>
            <path fill="#3882f6" d="M128 104a24 24 0 1 0 24 24 24 24 0 0 0-24-24Z"/>
          </svg>
          <h1 class="text-xl font-bold text-gray-900">Al Cham Chemical Plant</h1>
        </div>
        <div class="flex items-center">
          <div id="locationSharingControls" class="mr-4 hidden">
            <button id="toggleLocationSharingBtn" class="flex items-center px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
              <span id="locationSharingStatus" class="inline-block w-3 h-3 rounded-full mr-2 location-sharing-inactive"></span>
              <span id="locationSharingText">Share Location</span>
            </button>
          </div>
          <div class="mr-4 text-right">
            <span class="block text-sm text-gray-700" id="currentUserDisplay">User Name</span>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" id="userRoleBadge">
              Role
            </span>
          </div>
          <button id="logoutButton" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 text-sm">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- Tabs -->
      <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8">
          <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="map-tab">
            Map View
          </button>
          <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="customers-tab">
            Customers
          </button>
          <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="competitors-tab">
            Competitors
          </button>
          <button id="adminOnlyTab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="users-tab">
            Users
          </button>
        </nav>
      </div>

      <!-- Map Tab -->
      <div id="map-tab" class="tab-content active">
        <div class="bg-white shadow rounded-lg p-6 mb-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Territory Map</h2>
          
          <!-- Map Filters -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div>
              <label for="mapStatusFilter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="mapStatusFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Statuses</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="hard">Hard</option>
                <option value="potential">Potential</option>
              </select>
            </div>
            <div>
              <label for="mapCategoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <select id="mapCategoryFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Categories</option>
                <option value="paints">Paints</option>
                <option value="alkyde">Alkyde</option>
                <option value="cosmetics">Cosmetics</option>
              </select>
            </div>
            <div>
              <label for="mapCompetitorFilter" class="block text-sm font-medium text-gray-700 mb-1">Competitor</label>
              <select id="mapCompetitorFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Competitors</option>
                <!-- Competitor options will be added dynamically -->
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Show</label>
              <div class="flex space-x-4">
                <label class="inline-flex items-center">
                  <input type="checkbox" id="showCompetitors" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                  <span class="ml-2 text-sm text-gray-700">Competitors</span>
                </label>
                <label class="inline-flex items-center" id="showSalespeopleLabel">
                  <input type="checkbox" id="showSalespeople" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                  <span class="ml-2 text-sm text-gray-700">Salespeople</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Map Container -->
          <div class="relative">
            <div id="map" class="rounded-lg overflow-hidden"></div>
            
            <!-- Map Mode Toggle -->
            <div class="map-mode-toggle">
              <button id="viewModeBtn" class="active">View Mode</button>
              <button id="addModeBtn">Add Customer</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Customers Tab -->
      <div id="customers-tab" class="tab-content">
        <div class="bg-white shadow rounded-lg p-6 mb-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-medium text-gray-900">Customers</h2>
            <div class="flex space-x-2">
              <button id="exportCustomersBtn" class="bg-green-600 text-white py-1 px-3 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 text-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Export CSV
              </button>
              <button id="addCustomerBtn" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Customer
              </button>
            </div>
          </div>
          
          <!-- Customer Filters -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label for="customerStatusFilter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="customerStatusFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Statuses</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="hard">Hard</option>
                <option value="potential">Potential</option>
              </select>
            </div>
            <div>
              <label for="customerCategoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <select id="customerCategoryFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Categories</option>
                <option value="paints">Paints</option>
                <option value="alkyde">Alkyde</option>
                <option value="cosmetics">Cosmetics</option>
              </select>
            </div>
            <div>
              <label for="customerSearch" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
              <input type="text" id="customerSearch" placeholder="Search by name..." class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
          </div>
          
          <!-- Customer Table -->
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Visit</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Visit</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="customerTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Customer rows will be added here dynamically -->
                <tr>
                  <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">Loading customers...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Competitors Tab -->
      <div id="competitors-tab" class="tab-content">
        <div class="bg-white shadow rounded-lg p-6 mb-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-medium text-gray-900">Competitors</h2>
            <button id="addCompetitorBtn" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Add Competitor
            </button>
          </div>
          
          <!-- Competitor Filters -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="competitorCategoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <select id="competitorCategoryFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Categories</option>
                <option value="paints">Paints</option>
                <option value="alkyde">Alkyde</option>
                <option value="cosmetics">Cosmetics</option>
              </select>
            </div>
            <div>
              <label for="competitorSearch" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
              <input type="text" id="competitorSearch" placeholder="Search by name..." class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
          </div>
          
          <!-- Competitor Table -->
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customers</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="competitorTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Competitor rows will be added here dynamically -->
                <tr>
                  <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">Loading competitors...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users-tab" class="tab-content">
        <div class="bg-white shadow rounded-lg p-6 mb-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-medium text-gray-900">Users</h2>
            <button id="addUserBtn" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Add User
            </button>
          </div>
          
          <!-- User Filters -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="userRoleFilter" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
              <select id="userRoleFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="all">All Roles</option>
                <option value="admin">Administrator</option>
                <option value="salesperson">Salesperson</option>
              </select>
            </div>
            <div>
              <label for="userSearch" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
              <input type="text" id="userSearch" placeholder="Search by name..." class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
          </div>
          
          <!-- User Table -->
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                <!-- User rows will be added here dynamically -->
                <tr>
                  <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">Loading users...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCMSPqRbQaBqHA2NsdlUc2nOaPx9XxBH2E",
      authDomain: "backend-b4231.firebaseapp.com",
      projectId: "backend-b4231",
      storageBucket: "backend-b4231.firebasestorage.app",
      messagingSenderId: "938964208227",
      appId: "1:938964208227:web:d14d7c45a83027eeb34656",
      measurementId: "G-LVG8XR2067"
    };

    // Demo data for initial setup
    const demoCustomers = [
      {
        id: "1",
        name: "Damascus Pharmaceuticals",
        status: "active",
        category: "paints",
        address: "Damascus, Syria",
        contact: "+963 11 123 4567",
        lat: 33.5138,
        lng: 36.2765,
        lastVisit: "2023-05-15",
        nextVisit: "2023-06-30",
        competitorId: "1", // Link to competitor
        comments: [
          {
            text: "Customer interested in new alkyde products",
            date: "2023-05-15",
            user: "Hazem Abdeen"
          }
        ]
      },
      {
        id: "2",
        name: "Aleppo Medical Supplies",
        status: "hard",
        category: "cosmetics",
        address: "Aleppo, Syria",
        contact: "+963 21 456 7890",
        lat: 36.2021,
        lng: 37.1343,
        lastVisit: "2023-04-20",
        nextVisit: "2023-07-10",
        competitorId: "2", // Link to competitor
        comments: [
          {
            text: "Difficult to convince, needs special pricing",
            date: "2023-04-20",
            user: "Ahmad Khalid"
          }
        ]
      },
      {
        id: "3",
        name: "Homs Industrial Group",
        status: "active",
        category: "alkyde",
        address: "Homs, Syria",
        contact: "+963 31 789 0123",
        lat: 34.7324,
        lng: 36.7137,
        lastVisit: "2023-05-25",
        nextVisit: "2023-06-25",
        competitorId: "3", // Link to competitor
        comments: [
          {
            text: "Large order placed for alkyde resins",
            date: "2023-05-25",
            user: "Hazem Abdeen"
          }
        ]
      },
      {
        id: "4",
        name: "Latakia Cosmetics",
        status: "potential",
        category: "cosmetics",
        address: "Latakia, Syria",
        contact: "+963 41 234 5678",
        lat: 35.5225,
        lng: 35.7915,
        lastVisit: null,
        nextVisit: "2023-06-15",
        competitorId: "", // No competitor
        comments: []
      }
    ];
    
    const demoCompetitors = [
      {
        id: "1",
        name: "Syrian Chemical Industries",
        category: "paints",
        strength: "High",
        location: "Damascus",
        lat: 33.5225,
        lng: 36.3097
      },
      {
        id: "2",
        name: "Aleppo Cosmetics Co.",
        category: "cosmetics",
        strength: "Medium",
        location: "Aleppo",
        lat: 36.2021,
        lng: 37.1643
      },
      {
        id: "3",
        name: "Homs Alkyde Products",
        category: "alkyde",
        strength: "Low",
        location: "Homs",
        lat: 34.7324,
        lng: 36.7437
      }
    ];
    
    const demoUsers = [
      {
        id: "1",
        fullName: "Hazem Abdeen",
        username: "admin",
        password: "admin123",
        role: "admin",
        status: "active",
        locationSharing: false,
        lastLocation: null,
        lastLocationTime: null
      },
      {
        id: "2",
        fullName: "Ahmad Khalid",
        username: "sales1",
        password: "sales123",
        role: "salesperson",
        status: "active",
        locationSharing: false,
        lastLocation: { lat: 33.5138, lng: 36.2965 },
        lastLocationTime: new Date().toISOString()
      },
      {
        id: "3",
        fullName: "Mohammed Ali",
        username: "sales2",
        password: "sales123",
        role: "salesperson",
        status: "inactive",
        locationSharing: false,
        lastLocation: null,
        lastLocationTime: null
      }
    ];
    
    // Global variables
    let map = null;
    let markers = [];
    let competitorMarkers = [];
    let salespersonMarkers = [];
    let currentUser = null;
    let isAuthenticated = false;
    let firebase;
    let db;
    let mapMode = 'view'; // 'view' or 'add'
    let tempMarker = null; // Temporary marker for adding customers
    let clickedLatLng = null; // Store clicked coordinates
    let filteredCustomers = []; // Store filtered customers
    let filteredCompetitors = []; // Store filtered competitors
    let locationWatchId = null; // For geolocation tracking
    let locationUpdateInterval = null; // For periodic location updates
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Firebase
      try {
        firebase = window.firebase;
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase initialized successfully");
      } catch (error) {
        console.error("Error initializing Firebase:", error);
        // Continue with demo data
      }
      
      // Setup event listeners
      setupEventListeners();
    });
    
    // Setup event listeners
    function setupEventListeners() {
      // Login button
      document.getElementById('loginButton').addEventListener('click', handleLogin);
      
      // Enter key for login
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });
      
      // Logout button
      document.getElementById('logoutButton').addEventListener('click', handleLogout);
      
      // Tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
          switchTab(this.getAttribute('data-tab'));
        });
      });
      
      // Map mode buttons
      document.getElementById('viewModeBtn').addEventListener('click', () => setMapMode('view'));
      document.getElementById('addModeBtn').addEventListener('click', () => setMapMode('add'));
      
      // Add competitor button
      document.getElementById('addCompetitorBtn').addEventListener('click', function() {
        document.getElementById('addCompetitorModal').style.display = 'flex';
      });
      
      // Add user button
      document.getElementById('addUserBtn').addEventListener('click', function() {
        document.getElementById('addUserModal').style.display = 'flex';
      });
      
      // Add customer button (from customers tab)
      document.getElementById('addCustomerBtn').addEventListener('click', function() {
        // Populate competitor dropdown
        populateCompetitorDropdown('newCustomerCompetitor');
        
        // Show modal if in customers tab, otherwise switch to map tab
        if (document.getElementById('customers-tab').classList.contains('active')) {
          document.getElementById('addCustomerModal').style.display = 'flex';
        } else {
          switchTab('map-tab');
          setMapMode('add');
          showToast("Click on the map to add a new customer");
        }
      });
      
      // Close modals
      document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', function() {
          this.closest('.modal').style.display = 'none';
        });
      });
      
      // Save competitor button
      document.getElementById('saveCompetitorBtn').addEventListener('click', saveCompetitor);
      
      // Save user button
      document.getElementById('saveUserBtn').addEventListener('click', saveUser);
      
      // Save customer button
      document.getElementById('saveCustomerBtn').addEventListener('click', saveCustomer);
      
      // Update customer button
      document.getElementById('updateCustomerBtn').addEventListener('click', updateCustomer);
      
      // Add comment button
      document.getElementById('addCommentBtn').addEventListener('click', addComment);
      
      // Export customers to CSV
      document.getElementById('exportCustomersBtn').addEventListener('click', exportCustomersToCSV);
      
      // Filter change events
      document.getElementById('mapStatusFilter').addEventListener('change', applyMapFilters);
      document.getElementById('mapCategoryFilter').addEventListener('change', applyMapFilters);
      document.getElementById('mapCompetitorFilter').addEventListener('change', applyMapFilters);
      document.getElementById('showCompetitors').addEventListener('change', applyMapFilters);
      document.getElementById('showSalespeople').addEventListener('change', applyMapFilters);
      
      document.getElementById('customerStatusFilter').addEventListener('change', applyCustomerFilters);
      document.getElementById('customerCategoryFilter').addEventListener('change', applyCustomerFilters);
      document.getElementById('customerSearch').addEventListener('input', applyCustomerFilters);
      
      document.getElementById('competitorCategoryFilter').addEventListener('change', applyCompetitorFilters);
      document.getElementById('competitorSearch').addEventListener('input', applyCompetitorFilters);
      
      document.getElementById('userRoleFilter').addEventListener('change', applyUserFilters);
      document.getElementById('userSearch').addEventListener('input', applyUserFilters);
      
      // Location sharing toggle
      document.getElementById('toggleLocationSharingBtn').addEventListener('click', toggleLocationSharing);
    }
    
    // Show toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Handle login
    function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        const loginError = document.getElementById('loginError');
        loginError.textContent = 'Please enter both username and password';
        loginError.classList.remove('hidden');
        return;
      }
      
      // Check credentials against demo users
      const user = demoUsers.find(u => u.username === username && u.password === password);
      
      if (user) {
        // Set current user
        currentUser = user;
        isAuthenticated = true;
        
        // Show main content
        showMainContent();
      } else {
        // Show error
        const loginError = document.getElementById('loginError');
        loginError.textContent = 'Invalid username or password';
        loginError.classList.remove('hidden');
      }
    }
    
    // Show main content
    function showMainContent() {
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      // Update user display
      document.getElementById('currentUserDisplay').textContent = currentUser.fullName || currentUser.username;
      
      // Update role badge
      const roleBadge = document.getElementById('userRoleBadge');
      roleBadge.textContent = currentUser.role === 'admin' ? 'Administrator' : 'Salesperson';
      roleBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium';
      
      if (currentUser.role === 'admin') {
        roleBadge.classList.add('bg-purple-100', 'text-purple-800');
      } else {
        roleBadge.classList.add('bg-blue-100', 'text-blue-800');
      }
      
      // Update UI based on role
      updateUIForRole();
      
      // Initialize map
      initMap();
      
      // Populate competitor dropdown in map filter
      populateCompetitorFilterDropdown();
      
      // Load data
      loadCustomers();
      loadCompetitors();
      loadUsers();
      
      // Setup location sharing for salespeople
      if (currentUser.role === 'salesperson') {
        setupLocationSharing();
      }
    }
    
    // Update UI based on user role
    function updateUIForRole() {
      if (currentUser.role === 'admin') {
        // Show admin-only elements
        document.getElementById('adminOnlyTab').style.display = 'block';
        document.getElementById('showSalespeopleLabel').style.display = 'inline-flex';
        document.getElementById('locationSharingControls').style.display = 'none';
      } else {
        // Hide admin-only elements
        document.getElementById('adminOnlyTab').style.display = 'none';
        document.getElementById('showSalespeopleLabel').style.display = 'none';
        document.getElementById('locationSharingControls').style.display = 'block';
        
        // Update location sharing button state
        updateLocationSharingButton();
      }
    }
    
    // Setup location sharing for salespeople
    function setupLocationSharing() {
      // Show location sharing controls
      document.getElementById('locationSharingControls').style.display = 'block';
      
      // Update button state
      updateLocationSharingButton();
    }
    
    // Update location sharing button state
    function updateLocationSharingButton() {
      const statusIndicator = document.getElementById('locationSharingStatus');
      const statusText = document.getElementById('locationSharingText');
      
      if (currentUser.locationSharing) {
        statusIndicator.classList.remove('location-sharing-inactive');
        statusIndicator.classList.add('location-sharing-active');
        statusText.textContent = 'Stop Sharing';
      } else {
        statusIndicator.classList.remove('location-sharing-active');
        statusIndicator.classList.add('location-sharing-inactive');
        statusText.textContent = 'Share Location';
      }
    }
    
    // Toggle location sharing
    function toggleLocationSharing() {
      if (!currentUser || currentUser.role !== 'salesperson') return;
      
      if (currentUser.locationSharing) {
        // Stop sharing
        stopLocationSharing();
      } else {
        // Start sharing
        startLocationSharing();
      }
    }
    
    // Start location sharing
    function startLocationSharing() {
      if (!navigator.geolocation) {
        showToast("Geolocation is not supported by your browser");
        return;
      }
      
      // Check for permission
      navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
        if (result.state === 'denied') {
          showToast("Location permission is denied. Please enable it in your browser settings.");
          return;
        }
        
        // Set sharing flag
        currentUser.locationSharing = true;
        updateLocationSharingButton();
        
        // Start watching position
        locationWatchId = navigator.geolocation.watchPosition(
          updateUserLocation,
          handleLocationError,
          { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
        );
        
        // Set up periodic updates (every 2 minutes)
        locationUpdateInterval = setInterval(() => {
          navigator.geolocation.getCurrentPosition(
            updateUserLocation,
            handleLocationError,
            { enableHighAccuracy: true }
          );
        }, 120000);
        
        showToast("Location sharing started");
      });
    }
    
    // Stop location sharing
    function stopLocationSharing() {
      // Clear watch and interval
      if (locationWatchId !== null) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
      }
      
      if (locationUpdateInterval !== null) {
        clearInterval(locationUpdateInterval);
        locationUpdateInterval = null;
      }
      
      // Update user
      currentUser.locationSharing = false;
      updateLocationSharingButton();
      
      showToast("Location sharing stopped");
    }
    
    // Update user location
    function updateUserLocation(position) {
      const { latitude, longitude } = position.coords;
      
      // Update current user location
      currentUser.lastLocation = { lat: latitude, lng: longitude };
      currentUser.lastLocationTime = new Date().toISOString();
      
      // Update in demo data
      const userIndex = demoUsers.findIndex(u => u.id === currentUser.id);
      if (userIndex !== -1) {
        demoUsers[userIndex].lastLocation = currentUser.lastLocation;
        demoUsers[userIndex].lastLocationTime = currentUser.lastLocationTime;
      }
      
      // Update salesperson markers if admin is viewing the map
      if (map) {
        updateSalespersonMarkers();
      }
    }
    
    // Handle location error
    function handleLocationError(error) {
      let errorMessage;
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMessage = "Location permission denied";
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage = "Location information is unavailable";
          break;
        case error.TIMEOUT:
          errorMessage = "Location request timed out";
          break;
        default:
          errorMessage = "An unknown error occurred";
          break;
      }
      
      showToast(`Error: ${errorMessage}`);
      stopLocationSharing();
    }
    
    // Handle logout
    function handleLogout() {
      // Stop location sharing if active
      if (currentUser && currentUser.locationSharing) {
        stopLocationSharing();
      }
      
      // Clear current user
      currentUser = null;
      isAuthenticated = false;
      
      // Clear map if exists
      if (map) {
        map.remove();
        map = null;
      }
      
      // Show login form
      document.getElementById('loginOverlay').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
      
      // Clear login form
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginError').classList.add('hidden');
    }
    
    // Switch tab
    function switchTab(tabId) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabId).classList.add('active');
      
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        if (button.getAttribute('data-tab') === tabId) {
          button.classList.add('border-blue-500', 'text-blue-600');
          button.classList.remove('border-transparent', 'text-gray-500');
        } else {
          button.classList.remove('border-blue-500', 'text-blue-600');
          button.classList.add('border-transparent', 'text-gray-500');
        }
      });
      
      // Special handling for map tab
      if (tabId === 'map-tab' && map) {
        // Refresh map size after tab switch
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      }
    }
    
    // Initialize map
    function initMap() {
      // Create map centered on Syria
      map = L.map('map').setView([35.0, 38.0], 7);
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Add click event to map for adding customers
      map.on('click', function(e) {
        if (mapMode === 'add') {
          // Store clicked coordinates
          clickedLatLng = e.latlng;
          
          // Remove previous temporary marker if exists
          if (tempMarker) {
            map.removeLayer(tempMarker);
          }
          
          // Create temporary marker
          const markerHtml = `<div class="custom-marker status-active">+</div>`;
          const icon = L.divIcon({
            html: markerHtml,
            className: '',
            iconSize: [30, 30]
          });
          
          tempMarker = L.marker(e.latlng, { icon: icon }).addTo(map);
          
          // Show add customer form
          showAddCustomerForm();
        }
      });
      
      // Load markers
      loadCustomerMarkers();
      loadCompetitorMarkers();
      loadSalespersonMarkers();
    }
    
    // Set map mode
    function setMapMode(mode) {
      mapMode = mode;
      
      // Update button styles
      if (mode === 'view') {
        document.getElementById('viewModeBtn').classList.add('active');
        document.getElementById('addModeBtn').classList.remove('active');
        if (map) map.getContainer().style.cursor = '';
        
        // Remove temporary marker if exists
        if (tempMarker) {
          map.removeLayer(tempMarker);
          tempMarker = null;
        }
      } else {
        document.getElementById('viewModeBtn').classList.remove('active');
        document.getElementById('addModeBtn').classList.add('active');
        if (map) map.getContainer().style.cursor = 'crosshair';
        
        showToast("Click on the map to add a new customer");
      }
    }
    
    // Show add customer form
    function showAddCustomerForm() {
      // Clear form fields
      document.getElementById('newCustomerName').value = '';
      document.getElementById('newCustomerAddress').value = '';
      document.getElementById('newCustomerContact').value = '';
      
      // Populate competitor dropdown
      populateCompetitorDropdown('newCustomerCompetitor');
      
      // Show modal
      document.getElementById('addCustomerModal').style.display = 'flex';
    }
    
    // Populate competitor dropdown
    function populateCompetitorDropdown(elementId) {
      const dropdown = document.getElementById(elementId);
      
      // Clear existing options except the first one
      while (dropdown.options.length > 1) {
        dropdown.remove(1);
      }
      
      // Add competitor options
      demoCompetitors.forEach(competitor => {
        const option = document.createElement('option');
        option.value = competitor.id;
        option.textContent = competitor.name;
        dropdown.appendChild(option);
      });
    }
    
    // Populate competitor filter dropdown
    function populateCompetitorFilterDropdown() {
      const dropdown = document.getElementById('mapCompetitorFilter');
      
      // Clear existing options except the first one
      while (dropdown.options.length > 1) {
        dropdown.remove(1);
      }
      
      // Add competitor options
      demoCompetitors.forEach(competitor => {
        const option = document.createElement('option');
        option.value = competitor.id;
        option.textContent = competitor.name;
        dropdown.appendChild(option);
      });
    }
    
    // Load customer markers
    function loadCustomerMarkers() {
      // Clear existing markers
      markers.forEach(marker => {
        if (map && marker.marker) {
          map.removeLayer(marker.marker);
        }
      });
      markers = [];
      
      // Add customer markers
      filteredCustomers = [...demoCustomers]; // Start with all customers
      applyMapFilters(); // Apply filters
    }
    
    // Load competitor markers
    function loadCompetitorMarkers() {
      // Clear existing markers
      competitorMarkers.forEach(marker => {
        if (map && marker) {
          map.removeLayer(marker);
        }
      });
      competitorMarkers = [];
      
      // Add competitor markers
      demoCompetitors.forEach(competitor => {
        addCompetitorMarker(competitor);
      });
      
      // Apply filters
      applyMapFilters();
    }
    
    // Load salesperson markers
    function loadSalespersonMarkers() {
      // Clear existing markers
      salespersonMarkers.forEach(marker => {
        if (map && marker) {
          map.removeLayer(marker);
        }
      });
      salespersonMarkers = [];
      
      // Add salesperson markers for active users with location data
      const activeSalespeople = demoUsers.filter(user => 
        user.role === 'salesperson' && 
        user.status === 'active' && 
        user.lastLocation
      );
      
      activeSalespeople.forEach(salesperson => {
        addSalespersonMarker(salesperson);
      });
      
      // Apply filters
      applyMapFilters();
    }
    
    // Update salesperson markers
    function updateSalespersonMarkers() {
      // Clear existing markers
      salespersonMarkers.forEach(marker => {
        if (map && marker) {
          map.removeLayer(marker);
        }
      });
      salespersonMarkers = [];
      
      // Add salesperson markers for active users with location data
      const activeSalespeople = demoUsers.filter(user => 
        user.role === 'salesperson' && 
        user.status === 'active' && 
        user.lastLocation
      );
      
      activeSalespeople.forEach(salesperson => {
        addSalespersonMarker(salesperson);
      });
      
      // Apply filters
      applyMapFilters();
    }
    
    // Apply map filters
    function applyMapFilters() {
      const statusFilter = document.getElementById('mapStatusFilter').value;
      const categoryFilter = document.getElementById('mapCategoryFilter').value;
      const competitorFilter = document.getElementById('mapCompetitorFilter').value;
      const showCompetitors = document.getElementById('showCompetitors').checked;
      const showSalespeople = document.getElementById('showSalespeople') ? document.getElementById('showSalespeople').checked : false;
      
      // Filter customers
      filteredCustomers = demoCustomers.filter(customer => {
        // Status filter
        if (statusFilter !== 'all' && customer.status !== statusFilter) {
          return false;
        }
        
        // Category filter
        if (categoryFilter !== 'all' && customer.category !== categoryFilter) {
          return false;
        }
        
        // Competitor filter
        if (competitorFilter !== 'all' && customer.competitorId !== competitorFilter) {
          return false;
        }
        
        return true;
      });
      
      // Clear existing markers
      markers.forEach(marker => {
        if (map && marker.marker) {
          map.removeLayer(marker.marker);
        }
      });
      markers = [];
      
      // Add filtered customer markers
      filteredCustomers.forEach(customer => {
        addCustomerMarker(customer);
      });
      
      // Show/hide competitor markers
      competitorMarkers.forEach(marker => {
        if (map) {
          if (showCompetitors) {
            marker.addTo(map);
          } else {
            map.removeLayer(marker);
          }
        }
      });
      
      // Show/hide salesperson markers
      salespersonMarkers.forEach(marker => {
        if (map) {
          if (showSalespeople) {
            marker.addTo(map);
          } else {
            map.removeLayer(marker);
          }
        }
      });
    }
    
    // Apply customer filters
    function applyCustomerFilters() {
      const statusFilter = document.getElementById('customerStatusFilter').value;
      const categoryFilter = document.getElementById('customerCategoryFilter').value;
      const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
      
      // Filter customers
      filteredCustomers = demoCustomers.filter(customer => {
        // Status filter
        if (statusFilter !== 'all' && customer.status !== statusFilter) {
          return false;
        }
        
        // Category filter
        if (categoryFilter !== 'all' && customer.category !== categoryFilter) {
          return false;
        }
        
        // Search filter
        if (searchTerm && !customer.name.toLowerCase().includes(searchTerm)) {
          return false;
        }
        
        return true;
      });
      
      // Refresh customer list
      loadCustomerTable();
    }
    
    // Apply competitor filters
    function applyCompetitorFilters() {
      const categoryFilter = document.getElementById('competitorCategoryFilter').value;
      const searchTerm = document.getElementById('competitorSearch').value.toLowerCase();
      
      // Filter competitors
      filteredCompetitors = demoCompetitors.filter(competitor => {
        // Category filter
        if (categoryFilter !== 'all' && competitor.category !== categoryFilter) {
          return false;
        }
        
        // Search filter
        if (searchTerm && !competitor.name.toLowerCase().includes(searchTerm)) {
          return false;
        }
        
        return true;
      });
      
      // Refresh competitor list
      loadCompetitorTable();
    }
    
    // Apply user filters
    function applyUserFilters() {
      const roleFilter = document.getElementById('userRoleFilter').value;
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      
      // Filter users
      const filteredUsers = demoUsers.filter(user => {
        // Role filter
        if (roleFilter !== 'all' && user.role !== roleFilter) {
          return false;
        }
        
        // Search filter
        if (searchTerm && !user.fullName.toLowerCase().includes(searchTerm)) {
          return false;
        }
        
        return true;
      });
      
      // Refresh user list
      loadUserTable(filteredUsers);
    }
    
    // Add customer marker to map
    function addCustomerMarker(customer) {
      if (!map) return;
      
      // Create marker
      const markerHtml = `<div class="custom-marker status-${customer.status}">${customer.name.charAt(0)}</div>`;
      const icon = L.divIcon({
        html: markerHtml,
        className: '',
        iconSize: [30, 30]
      });
      
      const marker = L.marker([customer.lat, customer.lng], { icon: icon });
      
      // Find competitor if linked
      let competitorName = "None";
      if (customer.competitorId) {
        const competitor = demoCompetitors.find(c => c.id === customer.competitorId);
        if (competitor) {
          competitorName = competitor.name;
        }
      }
      
      // Create popup content
      const popupContent = `
        <div class="p-2">
          <h3 class="font-bold">${customer.name}</h3>
          <p class="text-sm mb-1">Status: <span class="font-medium">${capitalizeFirstLetter(customer.status)}</span></p>
          <p class="text-sm mb-1">Category: <span class="font-medium">${capitalizeFirstLetter(customer.category || 'N/A')}</span></p>
          <p class="text-sm mb-2">Main Competitor: <span class="font-medium">${competitorName}</span></p>
          <button class="edit-customer-btn bg-blue-600 text-white py-1 px-2 rounded-md text-xs" data-id="${customer.id}">Edit Customer</button>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      marker.addTo(map);
      
      // Add click event to edit button in popup
      marker.on('popupopen', function() {
        const editBtn = document.querySelector(`.edit-customer-btn[data-id="${customer.id}"]`);
        if (editBtn) {
          editBtn.addEventListener('click', function() {
            openEditCustomerModal(customer.id);
          });
        }
      });
      
      // Store marker with customer data
      markers.push({
        marker: marker,
        customer: customer
      });
    }
    
    // Add competitor marker to map
    function addCompetitorMarker(competitor) {
      if (!map) return;
      
      // Create marker
      const markerHtml = `<div class="competitor-marker"></div>`;
      const icon = L.divIcon({
        html: markerHtml,
        className: '',
        iconSize: [20, 20]
      });
      
      const marker = L.marker([competitor.lat, competitor.lng], { icon: icon });
      
      // Count customers using this competitor
      const customerCount = demoCustomers.filter(c => c.competitorId === competitor.id).length;
      
      // Create popup content
      const popupContent = `
        <div class="p-2">
          <h3 class="font-bold">${competitor.name}</h3>
          <p class="text-sm mb-1">Category: <span class="font-medium">${capitalizeFirstLetter(competitor.category)}</span></p>
          <p class="text-sm mb-1">Strength: <span class="font-medium">${competitor.strength}</span></p>
          <p class="text-sm mb-1">Customers: <span class="font-medium">${customerCount}</span></p>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      
      // Store marker
      competitorMarkers.push(marker);
    }
    
    // Add salesperson marker to map
    function addSalespersonMarker(salesperson) {
      if (!map || !salesperson.lastLocation) return;
      
      // Create marker
      const markerHtml = `<div class="salesperson-marker ${salesperson.locationSharing ? 'location-pulse' : ''}">${salesperson.fullName.charAt(0)}</div>`;
      const icon = L.divIcon({
        html: markerHtml,
        className: '',
        iconSize: [30, 30]
      });
      
      const marker = L.marker([salesperson.lastLocation.lat, salesperson.lastLocation.lng], { icon: icon });
      
      // Format last location time
      const lastLocationTime = salesperson.lastLocationTime ? formatDateTime(salesperson.lastLocationTime) : 'Unknown';
      
      // Create popup content
      const popupContent = `
        <div class="p-2">
          <h3 class="font-bold">${salesperson.fullName}</h3>
          <p class="text-sm mb-1">Status: <span class="font-medium">${capitalizeFirstLetter(salesperson.status)}</span></p>
          <p class="text-sm mb-1">Location Sharing: <span class="font-medium">${salesperson.locationSharing ? 'Active' : 'Inactive'}</span></p>
          <p class="text-sm mb-1">Last Update: <span class="font-medium">${lastLocationTime}</span></p>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      
      // Store marker
      salespersonMarkers.push(marker);
    }
    
    // Save customer
    function saveCustomer() {
      // Get form values
      const name = document.getElementById('newCustomerName').value.trim();
      const category = document.getElementById('newCustomerCategory').value;
      const status = document.getElementById('newCustomerStatus').value;
      const address = document.getElementById('newCustomerAddress').value.trim();
      const contact = document.getElementById('newCustomerContact').value.trim();
      const competitorId = document.getElementById('newCustomerCompetitor').value;
      
      // Validate
      if (!name) {
        showToast("Please enter a customer name");
        return;
      }
      
      // Check if we have coordinates from map click
      let lat = 0;
      let lng = 0;
      
      if (clickedLatLng) {
        lat = clickedLatLng.lat;
        lng = clickedLatLng.lng;
      } else {
        // If adding from modal without map click, use random coordinates in Syria
        lat = 35.0 + (Math.random() * 2 - 1);
        lng = 38.0 + (Math.random() * 2 - 1);
      }
      
      // Create new customer
      const newCustomer = {
        id: Date.now().toString(),
        name: name,
        category: category,
        status: status,
        address: address || 'No address provided',
        contact: contact || 'No contact provided',
        lat: lat,
        lng: lng,
        lastVisit: null,
        nextVisit: null,
        competitorId: competitorId,
        comments: []
      };
      
      // Add to demo data
      demoCustomers.push(newCustomer);
      
      // Remove temporary marker
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
      
      // Add customer marker
      addCustomerMarker(newCustomer);
      
      // Close modal
      document.getElementById('addCustomerModal').style.display = 'none';
      
      // Switch back to view mode if in map tab
      if (document.getElementById('map-tab').classList.contains('active')) {
        setMapMode('view');
      }
      
      // Refresh customer list
      loadCustomers();
      
      showToast("Customer added successfully");
    }
    
    // Open edit customer modal
    function openEditCustomerModal(customerId) {
      const customer = demoCustomers.find(c => c.id === customerId);
      if (!customer) {
        showToast("Customer not found");
        return;
      }
      
      // Set form values
      document.getElementById('editCustomerId').value = customer.id;
      document.getElementById('editCustomerName').value = customer.name;
      document.getElementById('editCustomerCategory').value = customer.category;
      document.getElementById('editCustomerStatus').value = customer.status;
      document.getElementById('editCustomerAddress').value = customer.address || '';
      document.getElementById('editCustomerContact').value = customer.contact || '';
      document.getElementById('editCustomerNextVisit').value = customer.nextVisit || '';
      
      // Populate competitor dropdown
      populateCompetitorDropdown('editCustomerCompetitor');
      document.getElementById('editCustomerCompetitor').value = customer.competitorId || '';
      
      // Load comments
      loadCustomerComments(customer);
      
      // Show modal
      document.getElementById('editCustomerModal').style.display = 'flex';
    }
    
    // Load customer comments
    function loadCustomerComments(customer) {
      const commentsContainer = document.getElementById('customerComments');
      
      if (!customer.comments || customer.comments.length === 0) {
        commentsContainer.innerHTML = '<div class="text-sm text-gray-500 italic">No comments yet</div>';
        return;
      }
      
      // Sort comments by date (newest first)
      const sortedComments = [...customer.comments].sort((a, b) => {
        return new Date(b.date) - new Date(a.date);
      });
      
      // Generate HTML
      let html = '';
      sortedComments.forEach(comment => {
        html += `
          <div class="comment-item">
            <div class="flex justify-between">
              <span class="comment-user">${comment.user}</span>
              <span class="comment-date">${formatDate(comment.date)}</span>
            </div>
            <div class="comment-text">${comment.text}</div>
          </div>
        `;
      });
      
      commentsContainer.innerHTML = html;
    }
    
    // Add comment
    function addComment() {
      const customerId = document.getElementById('editCustomerId').value;
      const commentText = document.getElementById('newComment').value.trim();
      
      if (!commentText) {
        showToast("Please enter a comment");
        return;
      }
      
      const customer = demoCustomers.find(c => c.id === customerId);
      if (!customer) {
        showToast("Customer not found");
        return;
      }
      
      // Create new comment
      const newComment = {
        text: commentText,
        date: new Date().toISOString().split('T')[0], // Today's date in YYYY-MM-DD format
        user: currentUser.fullName
      };
      
      // Add to customer
      if (!customer.comments) {
        customer.comments = [];
      }
      customer.comments.push(newComment);
      
      // Update last visit date
      customer.lastVisit = newComment.date;
      
      // Refresh comments
      loadCustomerComments(customer);
      
      // Clear comment field
      document.getElementById('newComment').value = '';
      
      showToast("Comment added successfully");
    }
    
    // Update customer
    function updateCustomer() {
      const customerId = document.getElementById('editCustomerId').value;
      const customer = demoCustomers.find(c => c.id === customerId);
      
      if (!customer) {
        showToast("Customer not found");
        return;
      }
      
      // Get form values
      const name = document.getElementById('editCustomerName').value.trim();
      const category = document.getElementById('editCustomerCategory').value;
      const status = document.getElementById('editCustomerStatus').value;
      const address = document.getElementById('editCustomerAddress').value.trim();
      const contact = document.getElementById('editCustomerContact').value.trim();
      const competitorId = document.getElementById('editCustomerCompetitor').value;
      const nextVisit = document.getElementById('editCustomerNextVisit').value;
      
      // Validate
      if (!name) {
        showToast("Please enter a customer name");
        return;
      }
      
      // Update customer
      customer.name = name;
      customer.category = category;
      customer.status = status;
      customer.address = address;
      customer.contact = contact;
      customer.competitorId = competitorId;
      customer.nextVisit = nextVisit;
      
      // Update marker
      const markerIndex = markers.findIndex(m => m.customer.id === customerId);
      if (markerIndex !== -1 && map) {
        map.removeLayer(markers[markerIndex].marker);
        markers.splice(markerIndex, 1);
        addCustomerMarker(customer);
      }
      
      // Close modal
      document.getElementById('editCustomerModal').style.display = 'none';
      
      // Refresh customer list
      loadCustomers();
      
      showToast("Customer updated successfully");
    }
    
    // Load customers for customer tab
    function loadCustomers() {
      // Set initial filters
      filteredCustomers = [...demoCustomers];
      
      // Apply filters
      applyCustomerFilters();
    }
    
    // Load customer table
    function loadCustomerTable() {
      const tableBody = document.getElementById('customerTableBody');
      
      // Clear table
      tableBody.innerHTML = '';
      
      if (filteredCustomers.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No customers found</td></tr>';
        return;
      }
      
      // Add customer rows
      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        
        // Format dates
        const lastVisitFormatted = customer.lastVisit ? formatDate(customer.lastVisit) : 'Not visited';
        const nextVisitFormatted = customer.nextVisit ? formatDate(customer.nextVisit) : 'Not scheduled';
        
        // Create status badge
        const statusClass = getStatusClass(customer.status);
        
        // Create actions based on user role
        let actionsHtml = `
          <button class="text-blue-600 hover:text-blue-900 edit-customer-btn mr-3" data-id="${customer.id}">Edit</button>
        `;
        
        // Only admins can delete
        if (currentUser.role === 'admin') {
          actionsHtml += `<button class="text-red-600 hover:text-red-900 delete-customer-btn" data-id="${customer.id}">Delete</button>`;
        }
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${customer.name}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
              ${capitalizeFirstLetter(customer.status)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${capitalizeFirstLetter(customer.category || 'N/A')}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${lastVisitFormatted}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${nextVisitFormatted}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            ${actionsHtml}
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.edit-customer-btn').forEach(button => {
        button.addEventListener('click', function() {
          const customerId = this.getAttribute('data-id');
          openEditCustomerModal(customerId);
        });
      });
      
      document.querySelectorAll('.delete-customer-btn').forEach(button => {
        button.addEventListener('click', function() {
          const customerId = this.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this customer?')) {
            deleteCustomer(customerId);
          }
        });
      });
    }
    
    // Load competitors for competitor tab
    function loadCompetitors() {
      // Set initial filters
      filteredCompetitors = [...demoCompetitors];
      
      // Apply filters
      applyCompetitorFilters();
    }
    
    // Load competitor table
    function loadCompetitorTable() {
      const tableBody = document.getElementById('competitorTableBody');
      
      // Clear table
      tableBody.innerHTML = '';
      
      if (filteredCompetitors.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No competitors found</td></tr>';
        return;
      }
      
      // Add competitor rows
      filteredCompetitors.forEach(competitor => {
        const row = document.createElement('tr');
        
        // Count customers using this competitor
        const customerCount = demoCustomers.filter(c => c.competitorId === competitor.id).length;
        
        // Create actions based on user role
        let actionsHtml = '';
        
        // Only admins can delete
        if (currentUser.role === 'admin') {
          actionsHtml = `<button class="text-red-600 hover:text-red-900 delete-competitor-btn" data-id="${competitor.id}">Delete</button>`;
        }
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${competitor.name}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${capitalizeFirstLetter(competitor.category)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${competitor.strength}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${competitor.location}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${customerCount}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            ${actionsHtml}
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to delete buttons
      document.querySelectorAll('.delete-competitor-btn').forEach(button => {
        button.addEventListener('click', function() {
          const competitorId = this.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this competitor?')) {
            deleteCompetitor(competitorId);
          }
        });
      });
    }
    
    // Load users for user tab
    function loadUsers() {
      // Apply filters
      applyUserFilters();
    }
    
    // Load user table
    function loadUserTable(filteredUsers) {
      const tableBody = document.getElementById('userTableBody');
      
      // Clear table
      tableBody.innerHTML = '';
      
      if (filteredUsers.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No users found</td></tr>';
        return;
      }
      
      // Add user rows
      filteredUsers.forEach(user => {
        const row = document.createElement('tr');
        
        // Create status badge
        const statusClass = user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
        
        // Create role badge
        const roleClass = user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';
        
        // Create location status
        let locationStatus = 'Not available';
        if (user.role === 'salesperson') {
          if (user.lastLocation) {
            const timeAgo = getTimeAgo(user.lastLocationTime);
            locationStatus = user.locationSharing ? 
              `<span class="text-green-600">Active (${timeAgo})</span>` : 
              `<span class="text-gray-600">Inactive (${timeAgo})</span>`;
          } else {
            locationStatus = '<span class="text-gray-500">No data</span>';
          }
        } else {
          locationStatus = '<span class="text-gray-500">N/A</span>';
        }
        
        // Create actions based on user role
        let actionsHtml = '';
        
        // Only admins can delete users and only if it's not themselves
        if (currentUser.role === 'admin' && currentUser.id !== user.id) {
          actionsHtml = `<button class="text-red-600 hover:text-red-900 delete-user-btn" data-id="${user.id}">Delete</button>`;
        }
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${user.fullName}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${user.username}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${roleClass}">
              ${capitalizeFirstLetter(user.role)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
              ${capitalizeFirstLetter(user.status)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            ${locationStatus}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            ${actionsHtml}
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to delete buttons
      document.querySelectorAll('.delete-user-btn').forEach(button => {
        button.addEventListener('click', function() {
          const userId = this.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this user?')) {
            deleteUser(userId);
          }
        });
      });
    }
    
    // Delete customer
    function deleteCustomer(customerId) {
      // Only admins can delete
      if (currentUser.role !== 'admin') {
        showToast("You don't have permission to delete customers");
        return;
      }
      
      // Find customer in demo data
      const customerIndex = demoCustomers.findIndex(c => c.id === customerId);
      
      if (customerIndex === -1) {
        showToast("Customer not found");
        return;
      }
      
      // Remove from demo data
      demoCustomers.splice(customerIndex, 1);
      
      // Remove marker
      const markerIndex = markers.findIndex(m => m.customer.id === customerId);
      if (markerIndex !== -1 && map) {
        map.removeLayer(markers[markerIndex].marker);
        markers.splice(markerIndex, 1);
      }
      
      // Refresh customer list
      loadCustomers();
      
      // Refresh competitor list (to update customer counts)
      loadCompetitors();
      
      showToast("Customer deleted successfully");
    }
    
    // Delete competitor
    function deleteCompetitor(competitorId) {
      // Only admins can delete
      if (currentUser.role !== 'admin') {
        showToast("You don't have permission to delete competitors");
        return;
      }
      
      // Find competitor in demo data
      const competitorIndex = demoCompetitors.findIndex(c => c.id === competitorId);
      
      if (competitorIndex === -1) {
        showToast("Competitor not found");
        return;
      }
      
      // Check if competitor is linked to any customers
      const linkedCustomers = demoCustomers.filter(c => c.competitorId === competitorId);
      if (linkedCustomers.length > 0) {
        if (!confirm(`This competitor is linked to ${linkedCustomers.length} customer(s). Deleting it will remove the link. Continue?`)) {
          return;
        }
        
        // Remove links
        linkedCustomers.forEach(customer => {
          customer.competitorId = "";
        });
      }
      
      // Remove from demo data
      demoCompetitors.splice(competitorIndex, 1);
      
      // Remove marker
      if (map && competitorMarkers.length > competitorIndex) {
        map.removeLayer(competitorMarkers[competitorIndex]);
        competitorMarkers.splice(competitorIndex, 1);
      }
      
      // Refresh competitor list
      loadCompetitors();
      
      // Refresh customer list
      loadCustomers();
      
      // Update competitor dropdowns
      populateCompetitorFilterDropdown();
      
      showToast("Competitor deleted successfully");
    }
    
    // Delete user
    function deleteUser(userId) {
      // Only admins can delete
      if (currentUser.role !== 'admin') {
        showToast("You don't have permission to delete users");
        return;
      }
      
      // Find user in demo data
      const userIndex = demoUsers.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showToast("User not found");
        return;
      }
      
      // Check if trying to delete current user
      if (currentUser && currentUser.id === userId) {
        showToast("You cannot delete your own account");
        return;
      }
      
      // Remove from demo data
      demoUsers.splice(userIndex, 1);
      
      // Refresh user list
      loadUsers();
      
      // Update salesperson markers
      updateSalespersonMarkers();
      
      showToast("User deleted successfully");
    }
    
    // Save competitor
    function saveCompetitor() {
      const name = document.getElementById('newCompetitorName').value.trim();
      const category = document.getElementById('newCompetitorCategory').value;
      const strength = document.getElementById('newCompetitorStrength').value;
      const location = document.getElementById('newCompetitorLocation').value.trim();
      
      if (!name || !location) {
        showToast("Please fill in all required fields");
        return;
      }
      
      // Create new competitor
      const newCompetitor = {
        id: Date.now().toString(),
        name: name,
        category: category,
        strength: strength,
        location: location,
        // Default coordinates for demo (Damascus)
        lat: 33.5138 + (Math.random() * 0.1 - 0.05),
        lng: 36.2765 + (Math.random() * 0.1 - 0.05)
      };
      
      // Add to demo data
      demoCompetitors.push(newCompetitor);
      
      // Add marker
      addCompetitorMarker(newCompetitor);
      
      // Refresh competitor list if visible
      loadCompetitors();
      
      // Update competitor dropdowns
      populateCompetitorFilterDropdown();
      
      // Close modal
      document.getElementById('addCompetitorModal').style.display = 'none';
      
      // Clear form
      document.getElementById('newCompetitorName').value = '';
      document.getElementById('newCompetitorLocation').value = '';
      
      showToast("Competitor added successfully");
    }
    
    // Save user
    function saveUser() {
      const fullName = document.getElementById('newUserFullName').value.trim();
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;
      const status = document.getElementById('newUserStatus').value;
      
      if (!fullName || !username || !password) {
        showToast("Please fill in all required fields");
        return;
      }
      
      // Check if username already exists
      if (demoUsers.some(u => u.username === username)) {
        showToast("Username already exists");
        return;
      }
      
      // Create new user
      const newUser = {
        id: Date.now().toString(),
        fullName: fullName,
        username: username,
        password: password,
        role: role,
        status: status,
        locationSharing: false,
        lastLocation: null,
        lastLocationTime: null
      };
      
      // Add to demo data
      demoUsers.push(newUser);
      
      // Refresh user list
      loadUsers();
      
      // Close modal
      document.getElementById('addUserModal').style.display = 'none';
      
      // Clear form
      document.getElementById('newUserFullName').value = '';
      document.getElementById('newUsername').value = '';
      document.getElementById('newUserPassword').value = '';
      
      showToast("User added successfully");
    }
    
    // Export customers to CSV
    function exportCustomersToCSV() {
      // Create CSV content
      let csvContent = "data:text/csv;charset=utf-8,";
      
      // Add headers
      csvContent += "Name,Status,Category,Address,Contact,Last Visit,Next Visit,Comments,Competitor,Latitude,Longitude\n";
      
      // Add customer data
      filteredCustomers.forEach(customer => {
        // Format comments
        const comments = customer.comments ? customer.comments.map(c => `"${c.date}: ${c.text} (${c.user})"`).join("; ") : "";
        
        // Get competitor name
        let competitorName = "";
        if (customer.competitorId) {
          const competitor = demoCompetitors.find(c => c.id === customer.competitorId);
          if (competitor) {
            competitorName = competitor.name;
          }
        }
        
        // Add row
        csvContent += [
          customer.name,
          customer.status,
          customer.category || "",
          customer.address || "",
          customer.contact || "",
          customer.lastVisit || "",
          customer.nextVisit || "",
          `"${comments}"`,
          competitorName,
          customer.lat,
          customer.lng
        ].join(",") + "\n";
      });
      
      // Create download link
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "customers_export.csv");
      document.body.appendChild(link);
      
      // Trigger download
      link.click();
      
      // Clean up
      document.body.removeChild(link);
      
      showToast("Customer data exported to CSV");
    }
    
    // Helper functions
    function capitalizeFirstLetter(string) {
      if (!string) return '';
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    
    function formatDateTime(dateTimeString) {
      if (!dateTimeString) return '';
      const date = new Date(dateTimeString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function getTimeAgo(dateTimeString) {
      if (!dateTimeString) return 'unknown';
      
      const date = new Date(dateTimeString);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.round(diffMs / 1000);
      const diffMin = Math.round(diffSec / 60);
      const diffHour = Math.round(diffMin / 60);
      const diffDay = Math.round(diffHour / 24);
      
      if (diffSec < 60) {
        return `${diffSec} sec ago`;
      } else if (diffMin < 60) {
        return `${diffMin} min ago`;
      } else if (diffHour < 24) {
        return `${diffHour} hr ago`;
      } else {
        return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
      }
    }
    
    function getStatusClass(status) {
      switch (status) {
        case 'active':
          return 'bg-green-100 text-green-800';
        case 'inactive':
          return 'bg-gray-100 text-gray-800';
        case 'hard':
          return 'bg-red-100 text-red-800';
        case 'potential':
          return 'bg-yellow-100 text-yellow-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966b37496362545a',t:'MTc1Mzc3NzQyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
